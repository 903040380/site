<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZEROPRESS</title>
  <link rel="stylesheet" href="/assets/client-entry-Dj2YQCT4.css">
  <body>
    <div id="root"><header class="pc:fixed absolute left-0 top-0 z-50 w-full"><div class="border-divider bg-bg-default h-nav border-b px-[12px] pt-px transition-colors duration-300"><div class="flex h-full items-center justify-between"><div class="flex h-full justify-start"><div class="h-full"><nav class="mx-[12px] flex h-full items-center"><a class="cursor-pointer"><img src="/logo.jpg" class="h-[24px] w-[24px]"/></a></nav></div></div><div class="flex h-full justify-end"><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">http</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-brand text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">react17</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">数据结构与算法</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">设计模式</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">笔记</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">总结</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">收集</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">业务</a></nav></div><div class="h-full"><nav class="mx-[4px] flex h-full items-center"><button class="bg-bg-switch border-divider hover:border-gray-1 relative h-[22px] w-[40px] rounded-[11px] border transition-colors duration-300"><div class="bg-bg-inverse shadow-1 absolute left-px top-px h-[18px] w-[18px] overflow-hidden rounded-[50%] transition-all duration-300 dark:translate-x-[18px]"><span class="*:text-text-2 *:absolute *:left-[3px] *:top-[3px] *:h-[12px] *:w-[12px] *:transition-opacity *:duration-300"><div class="icon-[carbon--sun] opacity-100 dark:opacity-0"></div><div class="icon-[carbon--moon] opacity-0 dark:opacity-100"></div></span></div></button></nav></div><div class="h-full"><nav class="mx-[12px] h-full"><a href="https://github.com/houhongxu/hhxpress" class="cursor-pointer text-text-2 text-hover flex  h-full items-center"><span class="icon-[carbon--logo-github] h-[24px] w-[24px]"></span></a></nav></div></div></div></div></header><div class="pt-nav"><aside class="mt-nav w-sidebar border-divider bg-bg-sidebar pc:-translate-x-0 fixed inset-y-0 left-0 z-40 -translate-x-full overflow-y-auto border-r px-[28px] py-[16px] transition-transform duration-300"><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>intro</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:108px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">流程</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">架构</a><a class="cursor-pointer text-brand text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">fiber</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">jsx</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>reconciler render</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:162px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">流程</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">mount阶段的beginWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">mount阶段的completeWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">update阶段的beginWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">update阶段的completeWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">进入commit()阶段</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>reconciler commit</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:27px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">流程</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><a class="cursor-pointer">readme</a></h2></div></aside><div class="pc:ml-sidebar ml-0 flex justify-between"><div class="mx-auto w-full max-w-[768px] transition-[margin] duration-300"><div class="h-nav pc:hidden bg-bg-default sticky top-0 z-50 w-full border-b"><div class="flex h-full items-center justify-between px-[24px]"><a class="icon-[carbon--list] h-[24px] w-[24px] cursor-pointer"></a><a class="icon-[carbon--border-top] h-[24px] w-[24px] cursor-pointer"></a></div><div class="fixed inset-0 bg-[#00000060] transition-all duration-300 opacity-0 invisible"></div><aside class="w-sidebar border-divider bg-bg-sidebar fixed inset-y-0 left-0 z-40 overflow-y-auto border-r px-[28px] py-[16px] transition-transform duration-300 -translate-x-full"><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>intro</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:108px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">流程</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">架构</a><a class="cursor-pointer text-brand text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">fiber</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">jsx</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>reconciler render</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:162px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">流程</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">mount阶段的beginWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">mount阶段的completeWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">update阶段的beginWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">update阶段的completeWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">进入commit()阶段</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>reconciler commit</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:27px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">流程</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><a class="cursor-pointer">readme</a></h2></div></aside><div class="fixed inset-0  bg-[#00000060] transition-all duration-300 opacity-0 invisible"></div><aside class="w-toc border-divider bg-bg-sidebar fixed inset-y-0 right-0 z-40  h-full border-l px-[28px] py-[16px] transition-transform duration-300 translate-x-full"><div class="border-divider pc:border-l px-[16px] font-[500]"><div class="pc:block bg-brand absolute left-0 hidden h-[18px] w-px transition-[opacity,top] duration-300" style="top:33px;opacity:0"></div><div class="text-[14px] font-[600] leading-[28px]">本页目录</div><div><div><a href="#fiber-的含义" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">fiber 的含义</a></div><div><a href="#架构" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:1rem">架构</a></div><div><a href="#静态数据结构" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:1rem">静态数据结构</a></div><div><a href="#动态工作单元" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:1rem">动态工作单元</a></div><div><a href="#双缓存" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">双缓存</a></div><div><a href="#mount" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:1rem">mount</a></div><div><a href="#update" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:1rem">update</a></div></div></div></aside></div><div class="p-[48px]"><div class="doc"><h1 id="fiber"><a class="autolink-headings" href="#fiber"><span style="margin-right:4px">#</span></a>fiber</h1>
<h2 id="fiber-的含义"><a class="autolink-headings" href="#fiber-的含义"><span style="margin-right:4px">#</span></a>fiber 的含义</h2>
<ul>
<li>架构：React15 的 Reconciler 采用递归的方式执行，数据保存在递归调用栈中，所以被称为 Stack Reconciler。React16 的 Reconciler 基于 Fiber 节点实现，被称为 Fiber Reconciler</li>
<li>静态数据结构：每个 Fiber 节点对应一个 React Element，保存了该组件的类型（函数组件/类组件/原生组件...）、对应的 DOM 节点等信息</li>
<li>动态工作单元：每个 Fiber 节点保存了本次更新中该组件改变的状态、要执行的工作（需要被
删除/被插入页面中/被更新...）</li>
</ul>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> FiberNode</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#E36209">  tag</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> WorkTag</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">  pendingProps</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> mixed</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">  key</span><span style="color:#D73A49">:</span><span style="color:#005CC5"> null</span><span style="color:#D73A49"> |</span><span style="color:#005CC5"> string</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">  mode</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> TypeOfMode</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">  // 作为静态数据结构的属性</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.tag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> tag</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.key </span><span style="color:#D73A49">=</span><span style="color:#24292E"> key</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.elementType </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.type </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.stateNode </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 用于连接其他Fiber节点形成Fiber树</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.return </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.child </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.sibling </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.index </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.ref </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 作为动态的工作单元的属性</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.pendingProps </span><span style="color:#D73A49">=</span><span style="color:#24292E"> pendingProps</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.memoizedProps </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.updateQueue </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.memoizedState </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.dependencies </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.mode </span><span style="color:#D73A49">=</span><span style="color:#24292E"> mode</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.effectTag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> NoEffect</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.nextEffect </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.firstEffect </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.lastEffect </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 调度优先级相关</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.lanes </span><span style="color:#D73A49">=</span><span style="color:#24292E"> NoLanes</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.childLanes </span><span style="color:#D73A49">=</span><span style="color:#24292E"> NoLanes</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 指向该fiber在另一次更新时对应的fiber</span></span>
<span data-line=""><span style="color:#005CC5">  this</span><span style="color:#24292E">.alternate </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure>
<h3 id="架构"><a class="autolink-headings" href="#架构"><span style="margin-right:4px">#</span></a>架构</h3>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#6A737D">// 指向父级Fiber节点</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.return </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#6A737D">// 指向子Fiber节点</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.child </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#6A737D">// 指向右边第一个兄弟Fiber节点</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.sibling </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span></code></pre></figure>
<h3 id="静态数据结构"><a class="autolink-headings" href="#静态数据结构"><span style="margin-right:4px">#</span></a>静态数据结构</h3>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#6A737D">// Fiber对应组件的类型 Function/Class/Host...</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.tag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> tag</span></span>
<span data-line=""><span style="color:#6A737D">// key属性</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.key </span><span style="color:#D73A49">=</span><span style="color:#24292E"> key</span></span>
<span data-line=""><span style="color:#6A737D">// 大部分情况同type，某些情况不同，比如FunctionComponent使用React.memo包裹</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.elementType </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#6A737D">// 对于 FunctionComponent，指函数本身，对于ClassComponent，指class，对于HostComponent，指DOM节点tagName</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.type </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#6A737D">// Fiber对应的真实DOM节点</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.stateNode </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span></code></pre></figure>
<h3 id="动态工作单元"><a class="autolink-headings" href="#动态工作单元"><span style="margin-right:4px">#</span></a>动态工作单元</h3>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#6A737D">// 保存本次更新造成的状态改变相关信息</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.pendingProps </span><span style="color:#D73A49">=</span><span style="color:#24292E"> pendingProps</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.memoizedProps </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.updateQueue </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.memoizedState </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.dependencies </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.mode </span><span style="color:#D73A49">=</span><span style="color:#24292E"> mode</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">// 保存本次更新会造成的DOM操作</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.effectTag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> NoEffect</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.nextEffect </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.firstEffect </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.lastEffect </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">// 调度优先级相关</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.lanes </span><span style="color:#D73A49">=</span><span style="color:#24292E"> NoLanes</span></span>
<span data-line=""><span style="color:#005CC5">this</span><span style="color:#24292E">.childLanes </span><span style="color:#D73A49">=</span><span style="color:#24292E"> NoLanes</span></span></code></pre></figure>
<h2 id="双缓存"><a class="autolink-headings" href="#双缓存"><span style="margin-right:4px">#</span></a>双缓存</h2>
<p>当前屏幕上显示内容对应的 Fiber 树称为 current Fiber 树，正在内存中构建的 Fiber 树称为 workInProgress Fiber 树。</p>
<p>current Fiber 树中的 Fiber 节点被称为 current fiber，workInProgress Fiber 树中的 Fiber 节点被称为 workInProgress fiber，他们通过 alternate 属性连接。</p>
<p>React 应用的根节点通过使 current 指针在不同 Fiber 树的 rootFiber 间切换来完成 current Fiber 树指向的切换。</p>
<h3 id="mount"><a class="autolink-headings" href="#mount"><span style="margin-right:4px">#</span></a>mount</h3>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">const</span><span style="color:#005CC5"> root</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> document.</span><span style="color:#6F42C1">getElementById</span><span style="color:#24292E">(</span><span style="color:#032F62">&#x27;root&#x27;</span><span style="color:#24292E">)</span></span>
<span data-line=""><span style="color:#24292E">ReactDOM.</span><span style="color:#6F42C1">render</span><span style="color:#24292E">(&lt;</span><span style="color:#005CC5">App</span><span style="color:#24292E"> /&gt;, root)</span></span></code></pre></figure>
<p><img src="/img/note/7/1.jpg" alt="1"/></p>
<ol>
<li>
<p>首次执行 ReactDOM.render 会创建 fiberRootNode（源码中叫 <strong>fiberRoot</strong>，避免混淆大写为 FiberRoot）和 rootFiber。</p>
<p>其后可以多次执行 ReactDOM.render 进行 rootFiber 的挂载</p>
<p><strong>其中 fiberRootNode 是整个应用的根节点，rootFiber 是<code>&lt;App/&gt;</code>所在组件树的根节点 id 为 root 的 div。</strong></p>
<p>fiberRootNode 的 current 会指向当前页面上已渲染内容对应 Fiber 树，即 current Fiber 树。</p>
<p><img src="/img/note/7/2.jpg" alt="2"/></p>
<p><code>fiberRootNode.current = rootFiber</code></p>
</li>
<li>
<p>接下来进入 render()阶段，根据组件返回的 JSX 在内存中依次创建 Fiber 节点并连接在一起构建 Fiber 树，被称为 workInProgress Fiber 树</p>
<p>在构建 workInProgress Fiber 树时会尝试复用 current Fiber 树中已有的 Fiber 节点内的属性，<strong>在首屏渲染时只有 rootFiber 存在对应的 current fiber</strong>（即 rootFiber.alternate）。</p>
<p><img src="/img/note/7/3.jpg" alt="3"/></p>
</li>
<li>
<p>图中右侧已构建完的 workInProgress Fiber 树在 commit()阶段渲染到页面。
此时 DOM 更新为右侧树对应的样子。</p>
<p>fiberRootNode 的 current 指针指向 workInProgress Fiber 树使其变为 current Fiber 树。
<img src="/img/note/7/4.jpg" alt="4"/></p>
</li>
</ol>
<h3 id="update"><a class="autolink-headings" href="#update"><span style="margin-right:4px">#</span></a>update</h3>
<ol>
<li>
<p>接下来我们点击 p 节点触发状态改变，这会开启一次新的 render 阶段并构建一棵新的 workInProgress Fiber 树。
<img src="/img/note/7/5.jpg" alt="5"/>
和 mount 时一样，workInProgress fiber 的创建可以复用 current Fiber 树对应的节点数据,复用的依据就是 <strong>Diff 算法</strong>。</p>
</li>
<li>
<p>workInProgress Fiber 树在 render 阶段完成构建后进入 commit 阶段渲染到页面上。渲染完毕后，workInProgress Fiber 树变为 current Fiber 树。</p>
</li>
</ol></div><footer class="mt-[32px]"><div class="border-divider flex justify-between border-t pt-[24px]"><div class="w-[calc(50%-4px)]"><a class="cursor-pointer border-divider hover:border-brand group block h-full w-full rounded-[8px] border px-[16px] py-[8px] transition-colors duration-300"><div class="text-text-2 text-[12px] font-[500] leading-[20px]">上一页</div><div class=" text-text-2 group-hover:text-brand overflow-hidden text-ellipsis whitespace-nowrap text-[14px] font-[500] leading-[20px] transition-colors duration-300">架构</div></a></div><div class="w-[calc(50%-4px)]"><a class="cursor-pointer border-divider hover:border-brand group block h-full w-full rounded-[8px] border px-[16px] py-[8px] transition-colors duration-300"><div class="text-text-2 text-[12px] font-[500] leading-[20px]">下一页</div><div class=" text-text-2 group-hover:text-brand overflow-hidden text-ellipsis whitespace-nowrap text-[14px] font-[500] leading-[20px] transition-colors duration-300">jsx</div></a></div></div></footer></div></div><aside class="w-toc full:flex sticky top-[calc(theme(spacing.nav)+48px)] hidden h-full flex-col"><div class="border-divider pc:border-l px-[16px] font-[500]"><div class="pc:block bg-brand absolute left-0 hidden h-[18px] w-px transition-[opacity,top] duration-300" style="top:33px;opacity:0"></div><div class="text-[14px] font-[600] leading-[28px]">本页目录</div><div><div><a href="#fiber-的含义" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">fiber 的含义</a></div><div><a href="#架构" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:1rem">架构</a></div><div><a href="#静态数据结构" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:1rem">静态数据结构</a></div><div><a href="#动态工作单元" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:1rem">动态工作单元</a></div><div><a href="#双缓存" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">双缓存</a></div><div><a href="#mount" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:1rem">mount</a></div><div><a href="#update" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:1rem">update</a></div></div></div></aside></div></div></div>
  
    <script type="module" src="/client-entry.js"></script>
    </body>
    
</html>
