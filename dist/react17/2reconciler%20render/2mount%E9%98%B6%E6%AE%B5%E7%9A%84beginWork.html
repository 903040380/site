<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZEROPRESS</title>
  <link rel="stylesheet" href="/assets/client-entry-Dj2YQCT4.css">
  <body>
    <div id="root"><header class="pc:fixed absolute left-0 top-0 z-50 w-full"><div class="border-divider bg-bg-default h-nav border-b px-[12px] pt-px transition-colors duration-300"><div class="flex h-full items-center justify-between"><div class="flex h-full justify-start"><div class="h-full"><nav class="mx-[12px] flex h-full items-center"><a class="cursor-pointer"><img src="/logo.jpg" class="h-[24px] w-[24px]"/></a></nav></div></div><div class="flex h-full justify-end"><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">http</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-brand text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">react17</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">数据结构与算法</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">设计模式</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">笔记</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">总结</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">收集</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">业务</a></nav></div><div class="h-full"><nav class="mx-[4px] flex h-full items-center"><button class="bg-bg-switch border-divider hover:border-gray-1 relative h-[22px] w-[40px] rounded-[11px] border transition-colors duration-300"><div class="bg-bg-inverse shadow-1 absolute left-px top-px h-[18px] w-[18px] overflow-hidden rounded-[50%] transition-all duration-300 dark:translate-x-[18px]"><span class="*:text-text-2 *:absolute *:left-[3px] *:top-[3px] *:h-[12px] *:w-[12px] *:transition-opacity *:duration-300"><div class="icon-[carbon--sun] opacity-100 dark:opacity-0"></div><div class="icon-[carbon--moon] opacity-0 dark:opacity-100"></div></span></div></button></nav></div><div class="h-full"><nav class="mx-[12px] h-full"><a href="https://github.com/houhongxu/hhxpress" class="cursor-pointer text-text-2 text-hover flex  h-full items-center"><span class="icon-[carbon--logo-github] h-[24px] w-[24px]"></span></a></nav></div></div></div></div></header><div class="pt-nav"><aside class="mt-nav w-sidebar border-divider bg-bg-sidebar pc:-translate-x-0 fixed inset-y-0 left-0 z-40 -translate-x-full overflow-y-auto border-r px-[28px] py-[16px] transition-transform duration-300"><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>intro</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:108px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">流程</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">架构</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">fiber</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">jsx</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>reconciler render</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:162px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">流程</a><a class="cursor-pointer text-brand text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">mount阶段的beginWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">mount阶段的completeWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">update阶段的beginWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">update阶段的completeWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">进入commit()阶段</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>reconciler commit</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:27px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">流程</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><a class="cursor-pointer">readme</a></h2></div></aside><div class="pc:ml-sidebar ml-0 flex justify-between"><div class="mx-auto w-full max-w-[768px] transition-[margin] duration-300"><div class="h-nav pc:hidden bg-bg-default sticky top-0 z-50 w-full border-b"><div class="flex h-full items-center justify-between px-[24px]"><a class="icon-[carbon--list] h-[24px] w-[24px] cursor-pointer"></a><a class="icon-[carbon--border-top] h-[24px] w-[24px] cursor-pointer"></a></div><div class="fixed inset-0 bg-[#00000060] transition-all duration-300 opacity-0 invisible"></div><aside class="w-sidebar border-divider bg-bg-sidebar fixed inset-y-0 left-0 z-40 overflow-y-auto border-r px-[28px] py-[16px] transition-transform duration-300 -translate-x-full"><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>intro</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:108px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">流程</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">架构</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">fiber</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">jsx</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>reconciler render</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:162px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">流程</a><a class="cursor-pointer text-brand text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">mount阶段的beginWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">mount阶段的completeWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">update阶段的beginWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">update阶段的completeWork</a><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">进入commit()阶段</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>reconciler commit</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:27px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover mb-[2px] overflow-hidden text-ellipsis whitespace-nowrap p-[2px] text-[14px]">流程</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><a class="cursor-pointer">readme</a></h2></div></aside><div class="fixed inset-0  bg-[#00000060] transition-all duration-300 opacity-0 invisible"></div><aside class="w-toc border-divider bg-bg-sidebar fixed inset-y-0 right-0 z-40  h-full border-l px-[28px] py-[16px] transition-transform duration-300 translate-x-full"><div class="border-divider pc:border-l px-[16px] font-[500]"><div class="pc:block bg-brand absolute left-0 hidden h-[18px] w-px transition-[opacity,top] duration-300" style="top:33px;opacity:0"></div><div class="text-[14px] font-[600] leading-[28px]">本页目录</div><div><div><a href="#先从-indexjs-开始" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">先从 index.js 开始</a></div><div><a href="#render" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">render()</a></div><div><a href="#legacyrendersubtreeintocontainer" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:1rem">legacyRenderSubtreeIntoContainer()</a></div><div><a href="#legacycreaterootfromdomcontainer" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:2rem">legacyCreateRootFromDOMContainer()</a></div><div><a href="#createworkinprogress" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">createWorkInProgress</a></div><div><a href="#beginwork" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">beginWork()</a></div><div><a href="#updatehostcomponent" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">updateHostComponent()</a></div><div><a href="#reconcilechildren" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:1rem">reconcileChildren()</a></div><div><a href="#childreconciler" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:2rem">ChildReconciler()</a></div><div><a href="#createfiberfromelement" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:3rem">createFiberFromElement</a></div><div><a href="#createfiberfromtypeandprops" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:3rem">createFiberFromTypeAndProps</a></div></div></div></aside></div><div class="p-[48px]"><div class="doc"><h1 id="mount-阶段的-beginwork"><a class="autolink-headings" href="#mount-阶段的-beginwork"><span style="margin-right:4px">#</span></a>mount 阶段的 beginWork</h1>
<p>:::tip
lane 关键字 相关的内容和调度相关，暂时跳过
:::</p>
<p><img src="/img/note/7/1.jpg" alt="1"/></p>
<p>:::note
fiberRoot 避免混淆大写为 FiberRoot</p>
<p>mount 顺序为 div:root(避免混淆称为 rootFiber)-&gt;App()-&gt;div-&gt;header-&gt;img 然后进入 completeWork，以 mount root 和 div 调试</p>
<p>react 优化了单文本子节点的节点如<code>&lt;a&gt;Learn React&lt;/a&gt;</code>，可以不进行子文本节点的挂载
:::</p>
<h2 id="先从-indexjs-开始"><a class="autolink-headings" href="#先从-indexjs-开始"><span style="margin-right:4px">#</span></a>先从 index.js 开始</h2>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">import</span><span style="color:#24292E"> React </span><span style="color:#D73A49">from</span><span style="color:#032F62"> &#x27;react&#x27;</span></span>
<span data-line=""><span style="color:#D73A49">import</span><span style="color:#24292E"> ReactDOM </span><span style="color:#D73A49">from</span><span style="color:#032F62"> &#x27;react-dom&#x27;</span></span>
<span data-line=""><span style="color:#D73A49">import</span><span style="color:#032F62"> &#x27;./index.css&#x27;</span></span>
<span data-line=""><span style="color:#D73A49">import</span><span style="color:#24292E"> App </span><span style="color:#D73A49">from</span><span style="color:#032F62"> &#x27;./App&#x27;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">const</span><span style="color:#005CC5"> root</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> document.</span><span style="color:#6F42C1">getElementById</span><span style="color:#24292E">(</span><span style="color:#032F62">&#x27;root&#x27;</span><span style="color:#24292E">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">//调用 ReactDOM.render 函数将 funcComp：App 挂载到 div:root(rootFiber) 标签下</span></span>
<span data-line=""><span style="color:#24292E">ReactDOM.</span><span style="color:#6F42C1">render</span><span style="color:#24292E">(&lt;</span><span style="color:#005CC5">App</span><span style="color:#24292E"> /&gt;, root)</span></span>
<span data-line=""><span style="color:#24292E">console.</span><span style="color:#6F42C1">log</span><span style="color:#24292E">(React.version)</span></span></code></pre></figure>
<h2 id="render"><a class="autolink-headings" href="#render"><span style="margin-right:4px">#</span></a>render()</h2>
<p>渲染，内容检查并调用 legacyRenderSubtreeIntoContainer()</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> render</span><span style="color:#24292E">(</span><span style="color:#E36209">element</span><span style="color:#24292E">, </span><span style="color:#E36209">container</span><span style="color:#24292E">, </span><span style="color:#E36209">callback</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">  // 内容检查，空container(rootFiber)报错</span></span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#6F42C1">isValidContainer</span><span style="color:#24292E">(container)) {</span></span>
<span data-line=""><span style="color:#24292E">    {</span></span>
<span data-line=""><span style="color:#D73A49">      throw</span><span style="color:#6F42C1"> Error</span><span style="color:#24292E">(</span><span style="color:#032F62">&#x27;Target container is not a DOM element.&#x27;</span><span style="color:#24292E">)</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 内容检查，已挂载的container(rootFiber)报错</span></span>
<span data-line=""><span style="color:#24292E">  {</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> isModernRoot </span><span style="color:#D73A49">=</span></span>
<span data-line=""><span style="color:#6F42C1">      isContainerMarkedAsRoot</span><span style="color:#24292E">(container) </span><span style="color:#D73A49">&amp;&amp;</span></span>
<span data-line=""><span style="color:#24292E">      container._reactRootContainer </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> undefined</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (isModernRoot) {</span></span>
<span data-line=""><span style="color:#6F42C1">      error</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#032F62">        &#x27;You are calling ReactDOM.render() on a container that was previously &#x27;</span><span style="color:#D73A49"> +</span></span>
<span data-line=""><span style="color:#032F62">          &#x27;passed to ReactDOM.createRoot(). This is not supported. &#x27;</span><span style="color:#D73A49"> +</span></span>
<span data-line=""><span style="color:#032F62">          &#x27;Did you mean to call root.render(element)?&#x27;</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">      )</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 将组件树挂载到container(rootFiber)上</span></span>
<span data-line=""><span style="color:#D73A49">  return</span><span style="color:#6F42C1"> legacyRenderSubtreeIntoContainer</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#005CC5">    null</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">    element,</span></span>
<span data-line=""><span style="color:#24292E">    container,</span></span>
<span data-line=""><span style="color:#005CC5">    false</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">    callback,</span></span>
<span data-line=""><span style="color:#24292E">  )</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure>
<h3 id="legacyrendersubtreeintocontainer"><a class="autolink-headings" href="#legacyrendersubtreeintocontainer"><span style="margin-right:4px">#</span></a>legacyRenderSubtreeIntoContainer()</h3>
<p>mount 组件树到 container 中，生成根 fiber</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> legacyRenderSubtreeIntoContainer</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#E36209">  parentComponent</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">  children</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">  container</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">  forceHydrate</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">  callback</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">  // 内容检查</span></span>
<span data-line=""><span style="color:#24292E">  {</span></span>
<span data-line=""><span style="color:#6F42C1">    topLevelUpdateWarnings</span><span style="color:#24292E">(container)</span></span>
<span data-line=""><span style="color:#6F42C1">    warnOnInvalidCallback$1</span><span style="color:#24292E">(callback </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> undefined</span><span style="color:#D73A49"> ?</span><span style="color:#005CC5"> null</span><span style="color:#D73A49"> :</span><span style="color:#24292E"> callback, </span><span style="color:#032F62">&#x27;render&#x27;</span><span style="color:#24292E">)</span></span>
<span data-line=""><span style="color:#24292E">  } </span><span style="color:#6A737D">// TODO: Without `any` type, Flow says &quot;Property cannot be accessed on any</span></span>
<span data-line=""><span style="color:#6A737D">  // member of intersection type.&quot; Whyyyyyy.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // mountrootFiberFiber时为undefined，注意此时container还是dom，_reactRootContainer后面赋值是他的fiber</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> root </span><span style="color:#D73A49">=</span><span style="color:#24292E"> container._reactRootContainer</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // FiberRoot也为undefined</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> fiberRoot</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 如果没有rootFiber，则生成rootFiber和FiberRoot</span></span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#24292E">root) {</span></span>
<span data-line=""><span style="color:#6A737D">    // Initial mount</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // TODO rootFiber(tag:3)的stateNode不应该是他的dom吗,为什么是FiberRoot(tag:0)?</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 为container(rootFiber)添加_reactRootContainer属性，值为rootFiber的父fiber(FiberRoot)的包裹对象</span></span>
<span data-line=""><span style="color:#24292E">    root </span><span style="color:#D73A49">=</span><span style="color:#24292E"> container._reactRootContainer </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> legacyCreateRootFromDOMContainer</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">      container,</span></span>
<span data-line=""><span style="color:#24292E">      forceHydrate,</span></span>
<span data-line=""><span style="color:#24292E">    )</span></span>
<span data-line=""><span style="color:#6A737D">    // 取出FiberRoot</span></span>
<span data-line=""><span style="color:#24292E">    fiberRoot </span><span style="color:#D73A49">=</span><span style="color:#24292E"> root._internalRoot</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 调用回调</span></span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">typeof</span><span style="color:#24292E"> callback </span><span style="color:#D73A49">===</span><span style="color:#032F62"> &#x27;function&#x27;</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">      var</span><span style="color:#24292E"> originalCallback </span><span style="color:#D73A49">=</span><span style="color:#24292E"> callback</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6F42C1">      callback</span><span style="color:#D73A49"> =</span><span style="color:#D73A49"> function</span><span style="color:#24292E"> () {</span></span>
<span data-line=""><span style="color:#D73A49">        var</span><span style="color:#24292E"> instance </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> getPublicRootInstance</span><span style="color:#24292E">(fiberRoot)</span></span>
<span data-line=""><span style="color:#24292E">        originalCallback.</span><span style="color:#6F42C1">call</span><span style="color:#24292E">(instance)</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#6A737D">// Initial mount should not be batched.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 进行一些调度器操作后进入beginWork()</span></span>
<span data-line=""><span style="color:#6F42C1">    unbatchedUpdates</span><span style="color:#24292E">(</span><span style="color:#D73A49">function</span><span style="color:#24292E"> () {</span></span>
<span data-line=""><span style="color:#6F42C1">      updateContainer</span><span style="color:#24292E">(children, fiberRoot, parentComponent, callback)</span></span>
<span data-line=""><span style="color:#24292E">    })</span></span>
<span data-line=""><span style="color:#24292E">  } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#24292E">    fiberRoot </span><span style="color:#D73A49">=</span><span style="color:#24292E"> root._internalRoot</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 调用回调</span></span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">typeof</span><span style="color:#24292E"> callback </span><span style="color:#D73A49">===</span><span style="color:#032F62"> &#x27;function&#x27;</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">      var</span><span style="color:#24292E"> _originalCallback </span><span style="color:#D73A49">=</span><span style="color:#24292E"> callback</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6F42C1">      callback</span><span style="color:#D73A49"> =</span><span style="color:#D73A49"> function</span><span style="color:#24292E"> () {</span></span>
<span data-line=""><span style="color:#D73A49">        var</span><span style="color:#24292E"> instance </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> getPublicRootInstance</span><span style="color:#24292E">(fiberRoot)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">        _originalCallback.</span><span style="color:#6F42C1">call</span><span style="color:#24292E">(instance)</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#6A737D">// Update</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 进行一些调度器操作后进入beginWork()</span></span>
<span data-line=""><span style="color:#6F42C1">    updateContainer</span><span style="color:#24292E">(children, fiberRoot, parentComponent, callback)</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  return</span><span style="color:#6F42C1"> getPublicRootInstance</span><span style="color:#24292E">(fiberRoot)</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure>
<h4 id="legacycreaterootfromdomcontainer"><a class="autolink-headings" href="#legacycreaterootfromdomcontainer"><span style="margin-right:4px">#</span></a>legacyCreateRootFromDOMContainer()</h4>
<p>为 domContainer 创建对应的 fiber</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> legacyCreateRootFromDOMContainer</span><span style="color:#24292E">(</span><span style="color:#E36209">container</span><span style="color:#24292E">, </span><span style="color:#E36209">forceHydrate</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">  // mountrootFiber时为false</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> shouldHydrate </span><span style="color:#D73A49">=</span></span>
<span data-line=""><span style="color:#24292E">    forceHydrate </span><span style="color:#D73A49">||</span><span style="color:#6F42C1"> shouldHydrateDueToLegacyHeuristic</span><span style="color:#24292E">(container) </span><span style="color:#6A737D">// First clear any existing content.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#24292E">shouldHydrate) {</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> warned </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> false</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> rootSibling</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    //mountrootFiber时rootSibling为null</span></span>
<span data-line=""><span style="color:#D73A49">    while</span><span style="color:#24292E"> ((rootSibling </span><span style="color:#D73A49">=</span><span style="color:#24292E"> container.lastChild)) {</span></span>
<span data-line=""><span style="color:#24292E">      {</span></span>
<span data-line=""><span style="color:#D73A49">        if</span><span style="color:#24292E"> (</span></span>
<span data-line=""><span style="color:#D73A49">          !</span><span style="color:#24292E">warned </span><span style="color:#D73A49">&amp;&amp;</span></span>
<span data-line=""><span style="color:#24292E">          rootSibling.nodeType </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> ELEMENT_NODE</span><span style="color:#D73A49"> &amp;&amp;</span></span>
<span data-line=""><span style="color:#24292E">          rootSibling.</span><span style="color:#6F42C1">hasAttribute</span><span style="color:#24292E">(</span><span style="color:#005CC5">ROOT_ATTRIBUTE_NAME</span><span style="color:#24292E">)</span></span>
<span data-line=""><span style="color:#24292E">        ) {</span></span>
<span data-line=""><span style="color:#24292E">          warned </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> true</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6F42C1">          error</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#032F62">            &#x27;render(): Target node has markup rendered by React, but there &#x27;</span><span style="color:#D73A49"> +</span></span>
<span data-line=""><span style="color:#032F62">              &#x27;are unrelated nodes as well. This is most commonly caused by &#x27;</span><span style="color:#D73A49"> +</span></span>
<span data-line=""><span style="color:#032F62">              &#x27;white-space inserted around server-rendered markup.&#x27;</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">          )</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">      container.</span><span style="color:#6F42C1">removeChild</span><span style="color:#24292E">(rootSibling)</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">  {</span></span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (shouldHydrate </span><span style="color:#D73A49">&amp;&amp;</span><span style="color:#D73A49"> !</span><span style="color:#24292E">forceHydrate </span><span style="color:#D73A49">&amp;&amp;</span><span style="color:#D73A49"> !</span><span style="color:#24292E">warnedAboutHydrateAPI) {</span></span>
<span data-line=""><span style="color:#24292E">      warnedAboutHydrateAPI </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> true</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6F42C1">      warn</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#032F62">        &#x27;render(): Calling ReactDOM.render() to hydrate server-rendered markup &#x27;</span><span style="color:#D73A49"> +</span></span>
<span data-line=""><span style="color:#032F62">          &#x27;will stop working in React v18. Replace the ReactDOM.render() call &#x27;</span><span style="color:#D73A49"> +</span></span>
<span data-line=""><span style="color:#032F62">          &#x27;with ReactDOM.hydrate() if you want React to attach to the server HTML.&#x27;</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">      )</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""><span style="color:#6A737D">  // 给container(rootFiber)的dom添加属性_reactContainer,__reactEvents,_reactListening，并返回ReactDomBlockingRoot,含有_internalRoot这个FiberRoot</span></span>
<span data-line=""><span style="color:#D73A49">  return</span><span style="color:#6F42C1"> createLegacyRoot</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">    container,</span></span>
<span data-line=""><span style="color:#24292E">    shouldHydrate</span></span>
<span data-line=""><span style="color:#D73A49">      ?</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#24292E">          hydrate: </span><span style="color:#005CC5">true</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""><span style="color:#D73A49">      :</span><span style="color:#005CC5"> undefined</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">  )</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure>
<h2 id="createworkinprogress"><a class="autolink-headings" href="#createworkinprogress"><span style="margin-right:4px">#</span></a>createWorkInProgress</h2>
<p>创建工作 fiber</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> createWorkInProgress</span><span style="color:#24292E">(</span><span style="color:#E36209">current</span><span style="color:#24292E">, </span><span style="color:#E36209">pendingProps</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">  // 首次mount时会执行一次创建rootFiber，后续则不进入，由beginWork()创建子fiber</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> workInProgress </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.alternate</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 首次mount，mountrootFiber时有current无workInProgress</span></span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (workInProgress </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">    // We use a double buffering pooling technique because we know that we&#x27;ll</span></span>
<span data-line=""><span style="color:#6A737D">    // only ever need at most two versions of a tree. We pool the &quot;other&quot; unused</span></span>
<span data-line=""><span style="color:#6A737D">    // node that we&#x27;re free to reuse. This is lazily created to avoid allocating</span></span>
<span data-line=""><span style="color:#6A737D">    // extra objects for things that are never updated. It also allow us to</span></span>
<span data-line=""><span style="color:#6A737D">    // reclaim the extra memory if needed.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 创建新的fiber</span></span>
<span data-line=""><span style="color:#24292E">    workInProgress </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> createFiber</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">      current.tag,</span></span>
<span data-line=""><span style="color:#24292E">      pendingProps,</span></span>
<span data-line=""><span style="color:#24292E">      current.key,</span></span>
<span data-line=""><span style="color:#24292E">      current.mode,</span></span>
<span data-line=""><span style="color:#24292E">    )</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 复制current属性</span></span>
<span data-line=""><span style="color:#24292E">    workInProgress.elementType </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.elementType</span></span>
<span data-line=""><span style="color:#24292E">    workInProgress.type </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.type</span></span>
<span data-line=""><span style="color:#24292E">    workInProgress.stateNode </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.stateNode</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">    {</span></span>
<span data-line=""><span style="color:#6A737D">      // DEV-only fields</span></span>
<span data-line=""><span style="color:#24292E">      workInProgress._debugID </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current._debugID</span></span>
<span data-line=""><span style="color:#24292E">      workInProgress._debugSource </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current._debugSource</span></span>
<span data-line=""><span style="color:#24292E">      workInProgress._debugOwner </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current._debugOwner</span></span>
<span data-line=""><span style="color:#24292E">      workInProgress._debugHookTypes </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current._debugHookTypes</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">    workInProgress.alternate </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current</span></span>
<span data-line=""><span style="color:#24292E">    current.alternate </span><span style="color:#D73A49">=</span><span style="color:#24292E"> workInProgress</span></span>
<span data-line=""><span style="color:#24292E">  } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#24292E">    workInProgress.pendingProps </span><span style="color:#D73A49">=</span><span style="color:#24292E"> pendingProps </span><span style="color:#6A737D">// Needed because Blocks store data on type.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">    workInProgress.type </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.type </span><span style="color:#6A737D">// We already have an alternate.</span></span>
<span data-line=""><span style="color:#6A737D">    // Reset the effect tag.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">    workInProgress.flags </span><span style="color:#D73A49">=</span><span style="color:#24292E"> NoFlags </span><span style="color:#6A737D">// The effect list is no longer valid.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">    workInProgress.nextEffect </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#24292E">    workInProgress.firstEffect </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#24292E">    workInProgress.lastEffect </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">    {</span></span>
<span data-line=""><span style="color:#6A737D">      // We intentionally reset, rather than copy, actualDuration &amp; actualStartTime.</span></span>
<span data-line=""><span style="color:#6A737D">      // This prevents time from endlessly accumulating in new commits.</span></span>
<span data-line=""><span style="color:#6A737D">      // This has the downside of resetting values for different priority renders,</span></span>
<span data-line=""><span style="color:#6A737D">      // But works for yielding (the common case) and should support resuming.</span></span>
<span data-line=""><span style="color:#24292E">      workInProgress.actualDuration </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span></span>
<span data-line=""><span style="color:#24292E">      workInProgress.actualStartTime </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> -</span><span style="color:#005CC5">1</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 复制current属性</span></span>
<span data-line=""><span style="color:#24292E">  workInProgress.childLanes </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.childLanes</span></span>
<span data-line=""><span style="color:#24292E">  workInProgress.lanes </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.lanes</span></span>
<span data-line=""><span style="color:#24292E">  workInProgress.child </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.child</span></span>
<span data-line=""><span style="color:#24292E">  workInProgress.memoizedProps </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.memoizedProps</span></span>
<span data-line=""><span style="color:#24292E">  workInProgress.memoizedState </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.memoizedState</span></span>
<span data-line=""><span style="color:#24292E">  workInProgress.updateQueue </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.updateQueue </span><span style="color:#6A737D">// Clone the dependencies object. This is mutated during the render phase, so</span></span>
<span data-line=""><span style="color:#6A737D">  // it cannot be shared with the current fiber.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> currentDependencies </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.dependencies</span></span>
<span data-line=""><span style="color:#24292E">  workInProgress.dependencies </span><span style="color:#D73A49">=</span></span>
<span data-line=""><span style="color:#24292E">    currentDependencies </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#D73A49">      ?</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#D73A49">      :</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#24292E">          lanes: currentDependencies.lanes,</span></span>
<span data-line=""><span style="color:#24292E">          firstContext: currentDependencies.firstContext,</span></span>
<span data-line=""><span style="color:#24292E">        } </span><span style="color:#6A737D">// These will be overridden during the parent&#x27;s reconciliation</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">  workInProgress.sibling </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.sibling</span></span>
<span data-line=""><span style="color:#24292E">  workInProgress.index </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.index</span></span>
<span data-line=""><span style="color:#24292E">  workInProgress.ref </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.ref</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">  {</span></span>
<span data-line=""><span style="color:#24292E">    workInProgress.selfBaseDuration </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.selfBaseDuration</span></span>
<span data-line=""><span style="color:#24292E">    workInProgress.treeBaseDuration </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.treeBaseDuration</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">  {</span></span>
<span data-line=""><span style="color:#24292E">    workInProgress._debugNeedsRemount </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current._debugNeedsRemount</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    switch</span><span style="color:#24292E"> (workInProgress.tag) {</span></span>
<span data-line=""><span style="color:#D73A49">      case</span><span style="color:#24292E"> IndeterminateComponent:</span></span>
<span data-line=""><span style="color:#D73A49">      case</span><span style="color:#24292E"> FunctionComponent:</span></span>
<span data-line=""><span style="color:#D73A49">      case</span><span style="color:#24292E"> SimpleMemoComponent:</span></span>
<span data-line=""><span style="color:#24292E">        workInProgress.type </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> resolveFunctionForHotReloading</span><span style="color:#24292E">(current.type)</span></span>
<span data-line=""><span style="color:#D73A49">        break</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      case</span><span style="color:#24292E"> ClassComponent:</span></span>
<span data-line=""><span style="color:#24292E">        workInProgress.type </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> resolveClassForHotReloading</span><span style="color:#24292E">(current.type)</span></span>
<span data-line=""><span style="color:#D73A49">        break</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      case</span><span style="color:#24292E"> ForwardRef:</span></span>
<span data-line=""><span style="color:#24292E">        workInProgress.type </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> resolveForwardRefForHotReloading</span><span style="color:#24292E">(current.type)</span></span>
<span data-line=""><span style="color:#D73A49">        break</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  return</span><span style="color:#24292E"> workInProgress</span></span>
<span data-line=""><span style="color:#24292E">} </span><span style="color:#6A737D">// Used to reuse a Fiber for a second pass.</span></span></code></pre></figure>
<h2 id="beginwork"><a class="autolink-headings" href="#beginwork"><span style="margin-right:4px">#</span></a>beginWork()</h2>
<p>开始工作</p>
<p>:::tip
tags 见 <a href="https://github.com/facebook/react/blob/17.0.0-dev/packages/react-reconciler/src/ReactWorkTags.js">https://github.com/facebook/react/blob/17.0.0-dev/packages/react-reconciler/src/ReactWorkTags.js</a>
:::</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> beginWork</span><span style="color:#24292E">(</span><span style="color:#E36209">current</span><span style="color:#24292E">, </span><span style="color:#E36209">workInProgress</span><span style="color:#24292E">, </span><span style="color:#E36209">renderLanes</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">  // mountrootFiber时，current的tag为3，对应HostRoot，首次mount只有这次调用有current，后续调用无current</span></span>
<span data-line=""><span style="color:#6A737D">  //mountApp()时current的elementType为funcComp:App(),即对应的App函数组件</span></span>
<span data-line=""><span style="color:#6A737D">  // mountdiv时current的elementType为div,即对应的div标签</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> updateLanes </span><span style="color:#D73A49">=</span><span style="color:#24292E"> workInProgress.lanes</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // debug相关</span></span>
<span data-line=""><span style="color:#24292E">  {</span></span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (workInProgress._debugNeedsRemount </span><span style="color:#D73A49">&amp;&amp;</span><span style="color:#24292E"> current </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">      // This will restart the begin phase with a new fiber.</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#6F42C1"> remountFiber</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">        current,</span></span>
<span data-line=""><span style="color:#24292E">        workInProgress,</span></span>
<span data-line=""><span style="color:#6F42C1">        createFiberFromTypeAndProps</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">          workInProgress.type,</span></span>
<span data-line=""><span style="color:#24292E">          workInProgress.key,</span></span>
<span data-line=""><span style="color:#24292E">          workInProgress.pendingProps,</span></span>
<span data-line=""><span style="color:#24292E">          workInProgress._debugOwner </span><span style="color:#D73A49">||</span><span style="color:#005CC5"> null</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">          workInProgress.mode,</span></span>
<span data-line=""><span style="color:#24292E">          workInProgress.lanes,</span></span>
<span data-line=""><span style="color:#24292E">        ),</span></span>
<span data-line=""><span style="color:#24292E">      )</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 总之，有current+属性未变化+优先级足够时，或者无current时，didReceiveUpdate=false,即复用current</span></span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (current </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> oldProps </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.memoizedProps</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> newProps </span><span style="color:#D73A49">=</span><span style="color:#24292E"> workInProgress.pendingProps</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // props与fiber.type改变时需要新建</span></span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (</span></span>
<span data-line=""><span style="color:#24292E">      oldProps </span><span style="color:#D73A49">!==</span><span style="color:#24292E"> newProps </span><span style="color:#D73A49">||</span></span>
<span data-line=""><span style="color:#6F42C1">      hasContextChanged</span><span style="color:#24292E">() </span><span style="color:#D73A49">||</span><span style="color:#6A737D"> // Force a re-render if the implementation changed due to hot reload:</span></span>
<span data-line=""><span style="color:#24292E">      workInProgress.type </span><span style="color:#D73A49">!==</span><span style="color:#24292E"> current.type</span></span>
<span data-line=""><span style="color:#24292E">    ) {</span></span>
<span data-line=""><span style="color:#6A737D">      // If props or context changed, mark the fiber as having performed work.</span></span>
<span data-line=""><span style="color:#6A737D">      // This may be unset if the props are determined to be equal later (memo).</span></span>
<span data-line=""><span style="color:#24292E">      didReceiveUpdate </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> true</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#D73A49">else</span><span style="color:#D73A49"> if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#6F42C1">includesSomeLane</span><span style="color:#24292E">(renderLanes, updateLanes)) {</span></span>
<span data-line=""><span style="color:#6A737D">      // !includesSomeLane(renderLanes, updateLanes)意味着当前fiber优先级不够</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">      didReceiveUpdate </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> false</span><span style="color:#6A737D"> // This fiber does not have any pending work. Bailout without entering</span></span>
<span data-line=""><span style="color:#6A737D">      // the begin phase. There&#x27;s still some bookkeeping we that needs to be done</span></span>
<span data-line=""><span style="color:#6A737D">      // in this optimized path, mostly pushing stuff onto the stack.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      switch</span><span style="color:#24292E"> (workInProgress.tag) {</span></span>
<span data-line=""><span style="color:#D73A49">        case</span><span style="color:#24292E"> HostRoot:</span></span>
<span data-line=""><span style="color:#6F42C1">          pushHostRootContext</span><span style="color:#24292E">(workInProgress)</span></span>
<span data-line=""><span style="color:#6F42C1">          resetHydrationState</span><span style="color:#24292E">()</span></span>
<span data-line=""><span style="color:#D73A49">          break</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">        case</span><span style="color:#24292E"> HostComponent:</span></span>
<span data-line=""><span style="color:#6F42C1">          pushHostContext</span><span style="color:#24292E">(workInProgress)</span></span>
<span data-line=""><span style="color:#D73A49">          break</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">        case</span><span style="color:#24292E"> ClassComponent: {</span></span>
<span data-line=""><span style="color:#D73A49">          var</span><span style="color:#24292E"> Component </span><span style="color:#D73A49">=</span><span style="color:#24292E"> workInProgress.type</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">          if</span><span style="color:#24292E"> (</span><span style="color:#6F42C1">isContextProvider</span><span style="color:#24292E">(Component)) {</span></span>
<span data-line=""><span style="color:#6F42C1">            pushContextProvider</span><span style="color:#24292E">(workInProgress)</span></span>
<span data-line=""><span style="color:#24292E">          }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">          break</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">        case</span><span style="color:#24292E"> HostPortal:</span></span>
<span data-line=""><span style="color:#6F42C1">          pushHostContainer</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">            workInProgress,</span></span>
<span data-line=""><span style="color:#24292E">            workInProgress.stateNode.containerInfo,</span></span>
<span data-line=""><span style="color:#24292E">          )</span></span>
<span data-line=""><span style="color:#D73A49">          break</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""><span style="color:#6A737D">      // 部分case省略</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">      // 复用current</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#6F42C1"> bailoutOnAlreadyFinishedWork</span><span style="color:#24292E">(current, workInProgress, renderLanes)</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> ((current.flags </span><span style="color:#D73A49">&amp;</span><span style="color:#24292E"> ForceUpdateForLegacySuspense) </span><span style="color:#D73A49">!==</span><span style="color:#24292E"> NoFlags) {</span></span>
<span data-line=""><span style="color:#6A737D">        // This is a special case that only exists for legacy mode.</span></span>
<span data-line=""><span style="color:#6A737D">        // See https://github.com/facebook/react/pull/19216.</span></span>
<span data-line=""><span style="color:#24292E">        didReceiveUpdate </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> true</span></span>
<span data-line=""><span style="color:#24292E">      } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6A737D">        // mountfiberRoot时</span></span>
<span data-line=""><span style="color:#6A737D">        // An update was scheduled on this fiber, but there are no new props</span></span>
<span data-line=""><span style="color:#6A737D">        // nor legacy context. Set this to false. If an update queue or context</span></span>
<span data-line=""><span style="color:#6A737D">        // consumer produces a changed value, it will set this to true. Otherwise,</span></span>
<span data-line=""><span style="color:#6A737D">        // the component will assume the children have not changed and bail out.</span></span>
<span data-line=""><span style="color:#24292E">        didReceiveUpdate </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> false</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6A737D">    // mountApp()及div及后续fiber时</span></span>
<span data-line=""><span style="color:#24292E">    didReceiveUpdate </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> false</span></span>
<span data-line=""><span style="color:#24292E">  } </span><span style="color:#6A737D">// Before entering the begin phase, clear pending update priority.</span></span>
<span data-line=""><span style="color:#6A737D">  // TODO: This assumes that we&#x27;re about to evaluate the component and process</span></span>
<span data-line=""><span style="color:#6A737D">  // the update queue. However, there&#x27;s an exception: SimpleMemoComponent</span></span>
<span data-line=""><span style="color:#6A737D">  // sometimes bails out later in the begin phase. This indicates that we should</span></span>
<span data-line=""><span style="color:#6A737D">  // move this assignment out of the common path and into each branch.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">  workInProgress.lanes </span><span style="color:#D73A49">=</span><span style="color:#24292E"> NoLanes</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 根据workInProgress.tag调用不同的函数，mountrootFiber时为upadateHostRoot，App()时为IndeterminateComponent，div时为HostComponent</span></span>
<span data-line=""><span style="color:#D73A49">  switch</span><span style="color:#24292E"> (workInProgress.tag) {</span></span>
<span data-line=""><span style="color:#6A737D">    // App()</span></span>
<span data-line=""><span style="color:#D73A49">    case</span><span style="color:#24292E"> IndeterminateComponent: {</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#6F42C1"> mountIndeterminateComponent</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">        current,</span></span>
<span data-line=""><span style="color:#24292E">        workInProgress,</span></span>
<span data-line=""><span style="color:#24292E">        workInProgress.type,</span></span>
<span data-line=""><span style="color:#24292E">        renderLanes,</span></span>
<span data-line=""><span style="color:#24292E">      )</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#6A737D">    // App()mount时不进入这个，更新时进入</span></span>
<span data-line=""><span style="color:#D73A49">    case</span><span style="color:#24292E"> FunctionComponent: {</span></span>
<span data-line=""><span style="color:#D73A49">      var</span><span style="color:#24292E"> _Component </span><span style="color:#D73A49">=</span><span style="color:#24292E"> workInProgress.type</span></span>
<span data-line=""><span style="color:#D73A49">      var</span><span style="color:#24292E"> unresolvedProps </span><span style="color:#D73A49">=</span><span style="color:#24292E"> workInProgress.pendingProps</span></span>
<span data-line=""><span style="color:#D73A49">      var</span><span style="color:#24292E"> resolvedProps </span><span style="color:#D73A49">=</span></span>
<span data-line=""><span style="color:#24292E">        workInProgress.elementType </span><span style="color:#D73A49">===</span><span style="color:#24292E"> _Component</span></span>
<span data-line=""><span style="color:#D73A49">          ?</span><span style="color:#24292E"> unresolvedProps</span></span>
<span data-line=""><span style="color:#D73A49">          :</span><span style="color:#6F42C1"> resolveDefaultProps</span><span style="color:#24292E">(_Component, unresolvedProps)</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#6F42C1"> updateFunctionComponent</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">        current,</span></span>
<span data-line=""><span style="color:#24292E">        workInProgress,</span></span>
<span data-line=""><span style="color:#24292E">        _Component,</span></span>
<span data-line=""><span style="color:#24292E">        resolvedProps,</span></span>
<span data-line=""><span style="color:#24292E">        renderLanes,</span></span>
<span data-line=""><span style="color:#24292E">      )</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // rootFiber</span></span>
<span data-line=""><span style="color:#D73A49">    case</span><span style="color:#24292E"> HostRoot:</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#6F42C1"> updateHostRoot</span><span style="color:#24292E">(current, workInProgress, renderLanes)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // div</span></span>
<span data-line=""><span style="color:#D73A49">    case</span><span style="color:#24292E"> HostComponent:</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#6F42C1"> updateHostComponent</span><span style="color:#24292E">(current, workInProgress, renderLanes)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    case</span><span style="color:#24292E"> HostText:</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#6F42C1"> updateHostText</span><span style="color:#24292E">(current, workInProgress)</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""><span style="color:#6A737D">  // 部分case和error省略</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure>
<h2 id="updatehostcomponent"><a class="autolink-headings" href="#updatehostcomponent"><span style="margin-right:4px">#</span></a>updateHostComponent()</h2>
<p>更新应用普通标签</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> updateHostComponent</span><span style="color:#24292E">(</span><span style="color:#E36209">current</span><span style="color:#24292E">, </span><span style="color:#E36209">workInProgress</span><span style="color:#24292E">, </span><span style="color:#E36209">renderLanes</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6F42C1">  pushHostContext</span><span style="color:#24292E">(workInProgress)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (current </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6F42C1">    tryToClaimNextHydratableInstance</span><span style="color:#24292E">(workInProgress)</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> type </span><span style="color:#D73A49">=</span><span style="color:#24292E"> workInProgress.type</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> nextProps </span><span style="color:#D73A49">=</span><span style="color:#24292E"> workInProgress.pendingProps</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> prevProps </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#D73A49"> ?</span><span style="color:#24292E"> current.memoizedProps </span><span style="color:#D73A49">:</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#6A737D">  // 拿到子节点</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> nextChildren </span><span style="color:#D73A49">=</span><span style="color:#24292E"> nextProps.children</span></span>
<span data-line=""><span style="color:#6A737D">  // 是否是单文本子节点的节点</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> isDirectTextChild </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> shouldSetTextContent</span><span style="color:#24292E">(type, nextProps)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 单文本子节点的节点优化mount</span></span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (isDirectTextChild) {</span></span>
<span data-line=""><span style="color:#6A737D">    // We special case a direct text child of a host node. This is a common</span></span>
<span data-line=""><span style="color:#6A737D">    // case. We won&#x27;t handle it as a reified child. We will instead handle</span></span>
<span data-line=""><span style="color:#6A737D">    // this in the host environment that also has access to this prop. That</span></span>
<span data-line=""><span style="color:#6A737D">    // avoids allocating another HostText fiber and traversing it.</span></span>
<span data-line=""><span style="color:#24292E">    nextChildren </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#24292E">  } </span><span style="color:#D73A49">else</span><span style="color:#D73A49"> if</span><span style="color:#24292E"> (prevProps </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#D73A49"> &amp;&amp;</span><span style="color:#6F42C1"> shouldSetTextContent</span><span style="color:#24292E">(type, prevProps)) {</span></span>
<span data-line=""><span style="color:#6A737D">    // If we&#x27;re switching from a direct text child to a normal child, or to</span></span>
<span data-line=""><span style="color:#6A737D">    // empty, we need to schedule the text content to be reset.</span></span>
<span data-line=""><span style="color:#24292E">    workInProgress.flags </span><span style="color:#D73A49">|=</span><span style="color:#24292E"> ContentReset</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6F42C1">  markRef</span><span style="color:#24292E">(current, workInProgress)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 创建子fiber（child属性），mountdiv时nextChildren为header</span></span>
<span data-line=""><span style="color:#6F42C1">  reconcileChildren</span><span style="color:#24292E">(current, workInProgress, nextChildren, renderLanes)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // reconcileChildren前workInProgress.child为null</span></span>
<span data-line=""><span style="color:#D73A49">  return</span><span style="color:#24292E"> workInProgress.child</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure>
<h3 id="reconcilechildren"><a class="autolink-headings" href="#reconcilechildren"><span style="margin-right:4px">#</span></a>reconcileChildren()</h3>
<p>协调（创建）子节点</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> reconcileChildren</span><span style="color:#24292E">(</span><span style="color:#E36209">current</span><span style="color:#24292E">, </span><span style="color:#E36209">workInProgress</span><span style="color:#24292E">, </span><span style="color:#E36209">nextChildren</span><span style="color:#24292E">, </span><span style="color:#E36209">renderLanes</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (current </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">    // If this is a fresh new component that hasn&#x27;t been rendered yet, we</span></span>
<span data-line=""><span style="color:#6A737D">    // won&#x27;t update its child set by applying minimal side-effects. Instead,</span></span>
<span data-line=""><span style="color:#6A737D">    // we will add them all to the child before it gets rendered. That means</span></span>
<span data-line=""><span style="color:#6A737D">    // we can optimize this reconciliation pass by not tracking side-effects.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // mountChildFibers不进行子fiber标记</span></span>
<span data-line=""><span style="color:#24292E">    workInProgress.child </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> mountChildFibers</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">      workInProgress,</span></span>
<span data-line=""><span style="color:#005CC5">      null</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">      nextChildren,</span></span>
<span data-line=""><span style="color:#24292E">      renderLanes,</span></span>
<span data-line=""><span style="color:#24292E">    )</span></span>
<span data-line=""><span style="color:#24292E">  } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6A737D">    // If the current child is the same as the work in progress, it means that</span></span>
<span data-line=""><span style="color:#6A737D">    // we haven&#x27;t yet started any work on these children. Therefore, we use</span></span>
<span data-line=""><span style="color:#6A737D">    // the clone algorithm to create a copy of all the current children.</span></span>
<span data-line=""><span style="color:#6A737D">    // If we had any progressed work already, that is invalid at this point so</span></span>
<span data-line=""><span style="color:#6A737D">    // let&#x27;s throw it out.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // reconcileChildFibers进行子fiber点标记，不标记就无法更新，但是rootFiber有current，所以rootFiber根据标记mount就行</span></span>
<span data-line=""><span style="color:#24292E">    workInProgress.child </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> reconcileChildFibers</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">      workInProgress,</span></span>
<span data-line=""><span style="color:#24292E">      current.child,</span></span>
<span data-line=""><span style="color:#24292E">      nextChildren,</span></span>
<span data-line=""><span style="color:#24292E">      renderLanes,</span></span>
<span data-line=""><span style="color:#24292E">    )</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure>
<h4 id="childreconciler"><a class="autolink-headings" href="#childreconciler"><span style="margin-right:4px">#</span></a>ChildReconciler()</h4>
<p>:::tip
render 不会操作 dom，所以为需要操作的节点加上标记
标记见 <a href="https://github.com/facebook/react/blob/17.0.0-dev/packages/react-reconciler/src/ReactFiberFlags.js">https://github.com/facebook/react/blob/17.0.0-dev/packages/react-reconciler/src/ReactFiberFlags.js</a>
:::</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#6A737D">// 根据传入的参数来判断是否进行标记</span></span>
<span data-line=""><span style="color:#D73A49">var</span><span style="color:#24292E"> reconcileChildFibers </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> ChildReconciler</span><span style="color:#24292E">(</span><span style="color:#005CC5">true</span><span style="color:#24292E">)</span></span>
<span data-line=""><span style="color:#D73A49">var</span><span style="color:#24292E"> mountChildFibers </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> ChildReconciler</span><span style="color:#24292E">(</span><span style="color:#005CC5">false</span><span style="color:#24292E">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">// 函数内函数很多，直接进入最后一个reconcileChildFibers()，与上方同名但是不同内容</span></span>
<span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> ChildReconciler</span><span style="color:#24292E">(</span><span style="color:#E36209">shouldTrackSideEffects</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">  // 需要删除子fiber时</span></span>
<span data-line=""><span style="color:#D73A49">  function</span><span style="color:#6F42C1"> deleteChild</span><span style="color:#24292E">(</span><span style="color:#E36209">returnFiber</span><span style="color:#24292E">, </span><span style="color:#E36209">childToDelete</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#24292E">shouldTrackSideEffects) {</span></span>
<span data-line=""><span style="color:#6A737D">      // Noop.</span></span>
<span data-line=""><span style="color:#D73A49">      return</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#6A737D">// Deletions are added in reversed order so we add it to the front.</span></span>
<span data-line=""><span style="color:#6A737D">    // At this point, the return fiber&#x27;s effect list is empty except for</span></span>
<span data-line=""><span style="color:#6A737D">    // deletions, so we can just append the deletion to the list. The remaining</span></span>
<span data-line=""><span style="color:#6A737D">    // effects aren&#x27;t added until the complete phase. Once we implement</span></span>
<span data-line=""><span style="color:#6A737D">    // resuming, this may not be true.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> last </span><span style="color:#D73A49">=</span><span style="color:#24292E"> returnFiber.lastEffect</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (last </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#24292E">      last.nextEffect </span><span style="color:#D73A49">=</span><span style="color:#24292E"> childToDelete</span></span>
<span data-line=""><span style="color:#24292E">      returnFiber.lastEffect </span><span style="color:#D73A49">=</span><span style="color:#24292E"> childToDelete</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#24292E">      returnFiber.firstEffect </span><span style="color:#D73A49">=</span><span style="color:#24292E"> returnFiber.lastEffect </span><span style="color:#D73A49">=</span><span style="color:#24292E"> childToDelete</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 追踪副作用则做标记</span></span>
<span data-line=""><span style="color:#24292E">    childToDelete.nextEffect </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#24292E">    childToDelete.flags </span><span style="color:#D73A49">=</span><span style="color:#24292E"> Deletion</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 需要插入子fiber时</span></span>
<span data-line=""><span style="color:#D73A49">  function</span><span style="color:#6F42C1"> placeChild</span><span style="color:#24292E">(</span><span style="color:#E36209">newFiber</span><span style="color:#24292E">, </span><span style="color:#E36209">lastPlacedIndex</span><span style="color:#24292E">, </span><span style="color:#E36209">newIndex</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#24292E">    newFiber.index </span><span style="color:#D73A49">=</span><span style="color:#24292E"> newIndex</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#24292E">shouldTrackSideEffects) {</span></span>
<span data-line=""><span style="color:#6A737D">      // Noop.</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#24292E"> lastPlacedIndex</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> current </span><span style="color:#D73A49">=</span><span style="color:#24292E"> newFiber.alternate</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (current </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">      var</span><span style="color:#24292E"> oldIndex </span><span style="color:#D73A49">=</span><span style="color:#24292E"> current.index</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (oldIndex </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> lastPlacedIndex) {</span></span>
<span data-line=""><span style="color:#6A737D">        // This is a move.</span></span>
<span data-line=""><span style="color:#6A737D">        // 追踪副作用则做标记</span></span>
<span data-line=""><span style="color:#24292E">        newFiber.flags </span><span style="color:#D73A49">=</span><span style="color:#24292E"> Placement</span></span>
<span data-line=""><span style="color:#D73A49">        return</span><span style="color:#24292E"> lastPlacedIndex</span></span>
<span data-line=""><span style="color:#24292E">      } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6A737D">        // This item can stay in place.</span></span>
<span data-line=""><span style="color:#D73A49">        return</span><span style="color:#24292E"> oldIndex</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6A737D">      // This is an insertion.</span></span>
<span data-line=""><span style="color:#24292E">      newFiber.flags </span><span style="color:#D73A49">=</span><span style="color:#24292E"> Placement</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#24292E"> lastPlacedIndex</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 首次mount时，只在mountrootFiber时标记子fiberApp()</span></span>
<span data-line=""><span style="color:#D73A49">  function</span><span style="color:#6F42C1"> placeSingleChild</span><span style="color:#24292E">(</span><span style="color:#E36209">newFiber</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">    // This is simpler for the single child case. We only need to do a</span></span>
<span data-line=""><span style="color:#6A737D">    // placement for inserting new children.</span></span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (shouldTrackSideEffects </span><span style="color:#D73A49">&amp;&amp;</span><span style="color:#24292E"> newFiber.alternate </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#24292E">      newFiber.flags </span><span style="color:#D73A49">=</span><span style="color:#24292E"> Placement</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    return</span><span style="color:#24292E"> newFiber</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 创建一个标签的fiber</span></span>
<span data-line=""><span style="color:#D73A49">  function</span><span style="color:#6F42C1"> reconcileSingleElement</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#E36209">    returnFiber</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">    currentFirstChild</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">    element</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">    lanes</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">  ) {</span></span>
<span data-line=""><span style="color:#6A737D">    // returnFiber为当前fiber，element为第一个子节点的react element</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> key </span><span style="color:#D73A49">=</span><span style="color:#24292E"> element.key</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> child </span><span style="color:#D73A49">=</span><span style="color:#24292E"> currentFirstChild</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 判断child是否存在，mountdiv时不存在</span></span>
<span data-line=""><span style="color:#D73A49">    while</span><span style="color:#24292E"> (child </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">      // TODO: If key === null and child.key === null, then this only applies to</span></span>
<span data-line=""><span style="color:#6A737D">      // the first item in the list.</span></span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (child.key </span><span style="color:#D73A49">===</span><span style="color:#24292E"> key) {</span></span>
<span data-line=""><span style="color:#D73A49">        switch</span><span style="color:#24292E"> (child.tag) {</span></span>
<span data-line=""><span style="color:#D73A49">          case</span><span style="color:#24292E"> Fragment: {</span></span>
<span data-line=""><span style="color:#D73A49">            if</span><span style="color:#24292E"> (element.type </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> REACT_FRAGMENT_TYPE</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6F42C1">              deleteRemainingChildren</span><span style="color:#24292E">(returnFiber, child.sibling)</span></span>
<span data-line=""><span style="color:#D73A49">              var</span><span style="color:#24292E"> existing </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> useFiber</span><span style="color:#24292E">(child, element.props.children)</span></span>
<span data-line=""><span style="color:#24292E">              existing.return </span><span style="color:#D73A49">=</span><span style="color:#24292E"> returnFiber</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">              {</span></span>
<span data-line=""><span style="color:#24292E">                existing._debugSource </span><span style="color:#D73A49">=</span><span style="color:#24292E"> element._source</span></span>
<span data-line=""><span style="color:#24292E">                existing._debugOwner </span><span style="color:#D73A49">=</span><span style="color:#24292E"> element._owner</span></span>
<span data-line=""><span style="color:#24292E">              }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">              return</span><span style="color:#24292E"> existing</span></span>
<span data-line=""><span style="color:#24292E">            }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">            break</span></span>
<span data-line=""><span style="color:#24292E">          }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">          case</span><span style="color:#24292E"> Block: {</span></span>
<span data-line=""><span style="color:#D73A49">            var</span><span style="color:#24292E"> type </span><span style="color:#D73A49">=</span><span style="color:#24292E"> element.type</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">            if</span><span style="color:#24292E"> (type.$typeof </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> REACT_LAZY_TYPE</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#24292E">              type </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> resolveLazyType</span><span style="color:#24292E">(type)</span></span>
<span data-line=""><span style="color:#24292E">            }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">            if</span><span style="color:#24292E"> (type.$typeof </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> REACT_BLOCK_TYPE</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">              // The new Block might not be initialized yet. We need to initialize</span></span>
<span data-line=""><span style="color:#6A737D">              // it in case initializing it turns out it would match.</span></span>
<span data-line=""><span style="color:#D73A49">              if</span><span style="color:#24292E"> (type._render </span><span style="color:#D73A49">===</span><span style="color:#24292E"> child.type._render) {</span></span>
<span data-line=""><span style="color:#6F42C1">                deleteRemainingChildren</span><span style="color:#24292E">(returnFiber, child.sibling)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">                var</span><span style="color:#24292E"> _existing2 </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> useFiber</span><span style="color:#24292E">(child, element.props)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">                _existing2.type </span><span style="color:#D73A49">=</span><span style="color:#24292E"> type</span></span>
<span data-line=""><span style="color:#24292E">                _existing2.return </span><span style="color:#D73A49">=</span><span style="color:#24292E"> returnFiber</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">                {</span></span>
<span data-line=""><span style="color:#24292E">                  _existing2._debugSource </span><span style="color:#D73A49">=</span><span style="color:#24292E"> element._source</span></span>
<span data-line=""><span style="color:#24292E">                  _existing2._debugOwner </span><span style="color:#D73A49">=</span><span style="color:#24292E"> element._owner</span></span>
<span data-line=""><span style="color:#24292E">                }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">                return</span><span style="color:#24292E"> _existing2</span></span>
<span data-line=""><span style="color:#24292E">              }</span></span>
<span data-line=""><span style="color:#24292E">            }</span></span>
<span data-line=""><span style="color:#24292E">          }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">          // We intentionally fallthrough here if enableBlocksAPI is not on.</span></span>
<span data-line=""><span style="color:#6A737D">          // eslint-disable-next-lined no-fallthrough</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">          default</span><span style="color:#24292E">: {</span></span>
<span data-line=""><span style="color:#D73A49">            if</span><span style="color:#24292E"> (</span></span>
<span data-line=""><span style="color:#24292E">              child.elementType </span><span style="color:#D73A49">===</span><span style="color:#24292E"> element.type </span><span style="color:#D73A49">||</span><span style="color:#6A737D"> // Keep this check inline so it only runs on the false path:</span></span>
<span data-line=""><span style="color:#6F42C1">              isCompatibleFamilyForHotReloading</span><span style="color:#24292E">(child, element)</span></span>
<span data-line=""><span style="color:#24292E">            ) {</span></span>
<span data-line=""><span style="color:#6F42C1">              deleteRemainingChildren</span><span style="color:#24292E">(returnFiber, child.sibling)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">              var</span><span style="color:#24292E"> _existing3 </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> useFiber</span><span style="color:#24292E">(child, element.props)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">              _existing3.ref </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> coerceRef</span><span style="color:#24292E">(returnFiber, child, element)</span></span>
<span data-line=""><span style="color:#24292E">              _existing3.return </span><span style="color:#D73A49">=</span><span style="color:#24292E"> returnFiber</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">              {</span></span>
<span data-line=""><span style="color:#24292E">                _existing3._debugSource </span><span style="color:#D73A49">=</span><span style="color:#24292E"> element._source</span></span>
<span data-line=""><span style="color:#24292E">                _existing3._debugOwner </span><span style="color:#D73A49">=</span><span style="color:#24292E"> element._owner</span></span>
<span data-line=""><span style="color:#24292E">              }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">              return</span><span style="color:#24292E"> _existing3</span></span>
<span data-line=""><span style="color:#24292E">            }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">            break</span></span>
<span data-line=""><span style="color:#24292E">          }</span></span>
<span data-line=""><span style="color:#24292E">        } </span><span style="color:#6A737D">// Didn&#x27;t match.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6F42C1">        deleteRemainingChildren</span><span style="color:#24292E">(returnFiber, child)</span></span>
<span data-line=""><span style="color:#D73A49">        break</span></span>
<span data-line=""><span style="color:#24292E">      } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6F42C1">        deleteChild</span><span style="color:#24292E">(returnFiber, child)</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">      child </span><span style="color:#D73A49">=</span><span style="color:#24292E"> child.sibling</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 根据 子节点 类型选择创建fiber函数</span></span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (element.type </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> REACT_FRAGMENT_TYPE</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">      var</span><span style="color:#24292E"> created </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> createFiberFromFragment</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">        element.props.children,</span></span>
<span data-line=""><span style="color:#24292E">        returnFiber.mode,</span></span>
<span data-line=""><span style="color:#24292E">        lanes,</span></span>
<span data-line=""><span style="color:#24292E">        element.key,</span></span>
<span data-line=""><span style="color:#24292E">      )</span></span>
<span data-line=""><span style="color:#24292E">      created.return </span><span style="color:#D73A49">=</span><span style="color:#24292E"> returnFiber</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#24292E"> created</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6A737D">      // mountdiv时进入此处</span></span>
<span data-line=""><span style="color:#D73A49">      var</span><span style="color:#24292E"> _created4 </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> createFiberFromElement</span><span style="color:#24292E">(element, returnFiber.mode, lanes)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">      _created4.ref </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> coerceRef</span><span style="color:#24292E">(returnFiber, currentFirstChild, element)</span></span>
<span data-line=""><span style="color:#24292E">      _created4.return </span><span style="color:#D73A49">=</span><span style="color:#24292E"> returnFiber</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#24292E"> _created4</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 创建一个文本标签的fiber</span></span>
<span data-line=""><span style="color:#D73A49">  function</span><span style="color:#6F42C1"> reconcileSingleTextNode</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#E36209">    returnFiber</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">    currentFirstChild</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">    textContent</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">    lanes</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">  ) {</span></span>
<span data-line=""><span style="color:#6A737D">    // There&#x27;s no need to check for keys on text nodes since we don&#x27;t have a</span></span>
<span data-line=""><span style="color:#6A737D">    // way to define them.</span></span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (currentFirstChild </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#D73A49"> &amp;&amp;</span><span style="color:#24292E"> currentFirstChild.tag </span><span style="color:#D73A49">===</span><span style="color:#24292E"> HostText) {</span></span>
<span data-line=""><span style="color:#6A737D">      // We already have an existing node so let&#x27;s just update it and delete</span></span>
<span data-line=""><span style="color:#6A737D">      // the rest.</span></span>
<span data-line=""><span style="color:#6F42C1">      deleteRemainingChildren</span><span style="color:#24292E">(returnFiber, currentFirstChild.sibling)</span></span>
<span data-line=""><span style="color:#D73A49">      var</span><span style="color:#24292E"> existing </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> useFiber</span><span style="color:#24292E">(currentFirstChild, textContent)</span></span>
<span data-line=""><span style="color:#24292E">      existing.return </span><span style="color:#D73A49">=</span><span style="color:#24292E"> returnFiber</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#24292E"> existing</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#6A737D">// The existing first child is not a text node so we need to create one</span></span>
<span data-line=""><span style="color:#6A737D">    // and delete the existing ones.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6F42C1">    deleteRemainingChildren</span><span style="color:#24292E">(returnFiber, currentFirstChild)</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> created </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> createFiberFromText</span><span style="color:#24292E">(textContent, returnFiber.mode, lanes)</span></span>
<span data-line=""><span style="color:#24292E">    created.return </span><span style="color:#D73A49">=</span><span style="color:#24292E"> returnFiber</span></span>
<span data-line=""><span style="color:#D73A49">    return</span><span style="color:#24292E"> created</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 名字是Array但是也是只创建一个fiber</span></span>
<span data-line=""><span style="color:#D73A49">  function</span><span style="color:#6F42C1"> reconcileChildrenArray</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#E36209">    returnFiber</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">    currentFirstChild</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">    newChildren</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">    lanes</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">  ) {</span></span>
<span data-line=""><span style="color:#6A737D">    // This algorithm can&#x27;t optimize by searching from both ends since we</span></span>
<span data-line=""><span style="color:#6A737D">    // don&#x27;t have backpointers on fibers. I&#x27;m trying to see how far we can get</span></span>
<span data-line=""><span style="color:#6A737D">    // with that model. If it ends up not being worth the tradeoffs, we can</span></span>
<span data-line=""><span style="color:#6A737D">    // add it later.</span></span>
<span data-line=""><span style="color:#6A737D">    // Even with a two ended optimization, we&#x27;d want to optimize for the case</span></span>
<span data-line=""><span style="color:#6A737D">    // where there are few changes and brute force the comparison instead of</span></span>
<span data-line=""><span style="color:#6A737D">    // going for the Map. It&#x27;d like to explore hitting that path first in</span></span>
<span data-line=""><span style="color:#6A737D">    // forward-only mode and only go for the Map once we notice that we need</span></span>
<span data-line=""><span style="color:#6A737D">    // lots of look ahead. This doesn&#x27;t handle reversal as well as two ended</span></span>
<span data-line=""><span style="color:#6A737D">    // search but that&#x27;s unusual. Besides, for the two ended optimization to</span></span>
<span data-line=""><span style="color:#6A737D">    // work on Iterables, we&#x27;d need to copy the whole set.</span></span>
<span data-line=""><span style="color:#6A737D">    // In this first iteration, we&#x27;ll just live with hitting the bad case</span></span>
<span data-line=""><span style="color:#6A737D">    // (adding everything to a Map) in for every insert/move.</span></span>
<span data-line=""><span style="color:#6A737D">    // If you change this code, also update reconcileChildrenIterator() which</span></span>
<span data-line=""><span style="color:#6A737D">    // uses the same algorithm.</span></span>
<span data-line=""><span style="color:#24292E">    {</span></span>
<span data-line=""><span style="color:#6A737D">      // First, validate keys.</span></span>
<span data-line=""><span style="color:#D73A49">      var</span><span style="color:#24292E"> knownKeys </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      for</span><span style="color:#24292E"> (</span><span style="color:#D73A49">var</span><span style="color:#24292E"> i </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">; i </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> newChildren.</span><span style="color:#005CC5">length</span><span style="color:#24292E">; i</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">        var</span><span style="color:#24292E"> child </span><span style="color:#D73A49">=</span><span style="color:#24292E"> newChildren[i]</span></span>
<span data-line=""><span style="color:#24292E">        knownKeys </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> warnOnInvalidKey</span><span style="color:#24292E">(child, knownKeys, returnFiber)</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> resultingFirstChild </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> previousNewFiber </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> oldFiber </span><span style="color:#D73A49">=</span><span style="color:#24292E"> currentFirstChild</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> lastPlacedIndex </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> newIdx </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> 0</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> nextOldFiber </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    for</span><span style="color:#24292E"> (; oldFiber </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#D73A49"> &amp;&amp;</span><span style="color:#24292E"> newIdx </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> newChildren.</span><span style="color:#005CC5">length</span><span style="color:#24292E">; newIdx</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (oldFiber.index </span><span style="color:#D73A49">&gt;</span><span style="color:#24292E"> newIdx) {</span></span>
<span data-line=""><span style="color:#24292E">        nextOldFiber </span><span style="color:#D73A49">=</span><span style="color:#24292E"> oldFiber</span></span>
<span data-line=""><span style="color:#24292E">        oldFiber </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#24292E">      } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#24292E">        nextOldFiber </span><span style="color:#D73A49">=</span><span style="color:#24292E"> oldFiber.sibling</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      var</span><span style="color:#24292E"> newFiber </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> updateSlot</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">        returnFiber,</span></span>
<span data-line=""><span style="color:#24292E">        oldFiber,</span></span>
<span data-line=""><span style="color:#24292E">        newChildren[newIdx],</span></span>
<span data-line=""><span style="color:#24292E">        lanes,</span></span>
<span data-line=""><span style="color:#24292E">      )</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (newFiber </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">        // TODO: This breaks on empty slots like null children. That&#x27;s</span></span>
<span data-line=""><span style="color:#6A737D">        // unfortunate because it triggers the slow path all the time. We need</span></span>
<span data-line=""><span style="color:#6A737D">        // a better way to communicate whether this was a miss or null,</span></span>
<span data-line=""><span style="color:#6A737D">        // boolean, undefined, etc.</span></span>
<span data-line=""><span style="color:#D73A49">        if</span><span style="color:#24292E"> (oldFiber </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#24292E">          oldFiber </span><span style="color:#D73A49">=</span><span style="color:#24292E"> nextOldFiber</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">        break</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (shouldTrackSideEffects) {</span></span>
<span data-line=""><span style="color:#D73A49">        if</span><span style="color:#24292E"> (oldFiber </span><span style="color:#D73A49">&amp;&amp;</span><span style="color:#24292E"> newFiber.alternate </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">          // We matched the slot, but we didn&#x27;t reuse the existing fiber, so we</span></span>
<span data-line=""><span style="color:#6A737D">          // need to delete the existing child.</span></span>
<span data-line=""><span style="color:#6F42C1">          deleteChild</span><span style="color:#24292E">(returnFiber, oldFiber)</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">      lastPlacedIndex </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> placeChild</span><span style="color:#24292E">(newFiber, lastPlacedIndex, newIdx)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (previousNewFiber </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">        // TODO: Move out of the loop. This only happens for the first run.</span></span>
<span data-line=""><span style="color:#24292E">        resultingFirstChild </span><span style="color:#D73A49">=</span><span style="color:#24292E"> newFiber</span></span>
<span data-line=""><span style="color:#24292E">      } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6A737D">        // TODO: Defer siblings if we&#x27;re not at the right index for this slot.</span></span>
<span data-line=""><span style="color:#6A737D">        // I.e. if we had null values before, then we want to defer this</span></span>
<span data-line=""><span style="color:#6A737D">        // for each null value. However, we also don&#x27;t want to call updateSlot</span></span>
<span data-line=""><span style="color:#6A737D">        // with the previous one.</span></span>
<span data-line=""><span style="color:#24292E">        previousNewFiber.sibling </span><span style="color:#D73A49">=</span><span style="color:#24292E"> newFiber</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">      previousNewFiber </span><span style="color:#D73A49">=</span><span style="color:#24292E"> newFiber</span></span>
<span data-line=""><span style="color:#24292E">      oldFiber </span><span style="color:#D73A49">=</span><span style="color:#24292E"> nextOldFiber</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (newIdx </span><span style="color:#D73A49">===</span><span style="color:#24292E"> newChildren.</span><span style="color:#005CC5">length</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">      // We&#x27;ve reached the end of the new children. We can delete the rest.</span></span>
<span data-line=""><span style="color:#6F42C1">      deleteRemainingChildren</span><span style="color:#24292E">(returnFiber, oldFiber)</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#24292E"> resultingFirstChild</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (oldFiber </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">      // If we don&#x27;t have any more existing children we can choose a fast path</span></span>
<span data-line=""><span style="color:#6A737D">      // since the rest will all be insertions.</span></span>
<span data-line=""><span style="color:#D73A49">      for</span><span style="color:#24292E"> (; newIdx </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> newChildren.</span><span style="color:#005CC5">length</span><span style="color:#24292E">; newIdx</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">        var</span><span style="color:#24292E"> _newFiber </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> createChild</span><span style="color:#24292E">(returnFiber, newChildren[newIdx], lanes)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">        if</span><span style="color:#24292E"> (_newFiber </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">          continue</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">        lastPlacedIndex </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> placeChild</span><span style="color:#24292E">(_newFiber, lastPlacedIndex, newIdx)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">        if</span><span style="color:#24292E"> (previousNewFiber </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">          // TODO: Move out of the loop. This only happens for the first run.</span></span>
<span data-line=""><span style="color:#24292E">          resultingFirstChild </span><span style="color:#D73A49">=</span><span style="color:#24292E"> _newFiber</span></span>
<span data-line=""><span style="color:#24292E">        } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#24292E">          previousNewFiber.sibling </span><span style="color:#D73A49">=</span><span style="color:#24292E"> _newFiber</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">        previousNewFiber </span><span style="color:#D73A49">=</span><span style="color:#24292E"> _newFiber</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#24292E"> resultingFirstChild</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#6A737D">// Add all children to a key map for quick lookups.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> existingChildren </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> mapRemainingChildren</span><span style="color:#24292E">(returnFiber, oldFiber) </span><span style="color:#6A737D">// Keep scanning and use the map to restore deleted items as moves.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    for</span><span style="color:#24292E"> (; newIdx </span><span style="color:#D73A49">&lt;</span><span style="color:#24292E"> newChildren.</span><span style="color:#005CC5">length</span><span style="color:#24292E">; newIdx</span><span style="color:#D73A49">++</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">      var</span><span style="color:#24292E"> _newFiber2 </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> updateFromMap</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">        existingChildren,</span></span>
<span data-line=""><span style="color:#24292E">        returnFiber,</span></span>
<span data-line=""><span style="color:#24292E">        newIdx,</span></span>
<span data-line=""><span style="color:#24292E">        newChildren[newIdx],</span></span>
<span data-line=""><span style="color:#24292E">        lanes,</span></span>
<span data-line=""><span style="color:#24292E">      )</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (_newFiber2 </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">        if</span><span style="color:#24292E"> (shouldTrackSideEffects) {</span></span>
<span data-line=""><span style="color:#D73A49">          if</span><span style="color:#24292E"> (_newFiber2.alternate </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">            // The new fiber is a work in progress, but if there exists a</span></span>
<span data-line=""><span style="color:#6A737D">            // current, that means that we reused the fiber. We need to delete</span></span>
<span data-line=""><span style="color:#6A737D">            // it from the child list so that we don&#x27;t add it to the deletion</span></span>
<span data-line=""><span style="color:#6A737D">            // list.</span></span>
<span data-line=""><span style="color:#24292E">            existingChildren.</span><span style="color:#6F42C1">delete</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">              _newFiber2.key </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span><span style="color:#D73A49"> ?</span><span style="color:#24292E"> newIdx </span><span style="color:#D73A49">:</span><span style="color:#24292E"> _newFiber2.key,</span></span>
<span data-line=""><span style="color:#24292E">            )</span></span>
<span data-line=""><span style="color:#24292E">          }</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">        lastPlacedIndex </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> placeChild</span><span style="color:#24292E">(_newFiber2, lastPlacedIndex, newIdx)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">        if</span><span style="color:#24292E"> (previousNewFiber </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#24292E">          resultingFirstChild </span><span style="color:#D73A49">=</span><span style="color:#24292E"> _newFiber2</span></span>
<span data-line=""><span style="color:#24292E">        } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#24292E">          previousNewFiber.sibling </span><span style="color:#D73A49">=</span><span style="color:#24292E"> _newFiber2</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">        previousNewFiber </span><span style="color:#D73A49">=</span><span style="color:#24292E"> _newFiber2</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (shouldTrackSideEffects) {</span></span>
<span data-line=""><span style="color:#6A737D">      // Any existing children that weren&#x27;t consumed above were deleted. We need</span></span>
<span data-line=""><span style="color:#6A737D">      // to add them to the deletion list.</span></span>
<span data-line=""><span style="color:#24292E">      existingChildren.</span><span style="color:#6F42C1">forEach</span><span style="color:#24292E">(</span><span style="color:#D73A49">function</span><span style="color:#24292E"> (</span><span style="color:#E36209">child</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">        return</span><span style="color:#6F42C1"> deleteChild</span><span style="color:#24292E">(returnFiber, child)</span></span>
<span data-line=""><span style="color:#24292E">      })</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    return</span><span style="color:#24292E"> resultingFirstChild</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 省略部分函数</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // This API will tag the children with the side-effect of the reconciliation</span></span>
<span data-line=""><span style="color:#6A737D">  // itself. They will be added to the side-effect list as we pass through the</span></span>
<span data-line=""><span style="color:#6A737D">  // children and the parent.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  function</span><span style="color:#6F42C1"> reconcileChildFibers</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#E36209">    returnFiber</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">    currentFirstChild</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">    newChild</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">    lanes</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">  ) {</span></span>
<span data-line=""><span style="color:#6A737D">    // This function is not recursive.</span></span>
<span data-line=""><span style="color:#6A737D">    // If the top level item is an array, we treat it as a set of children,</span></span>
<span data-line=""><span style="color:#6A737D">    // not as a fragment. Nested arrays on the other hand will be treated as</span></span>
<span data-line=""><span style="color:#6A737D">    // fragment nodes. Recursion happens at the normal flow.</span></span>
<span data-line=""><span style="color:#6A737D">    // Handle top level unkeyed fragments as if they were arrays.</span></span>
<span data-line=""><span style="color:#6A737D">    // This leads to an ambiguity between &lt;&gt;{[...]}&lt;/&gt; and &lt;&gt;...&lt;/&gt;.</span></span>
<span data-line=""><span style="color:#6A737D">    // We treat the ambiguous cases above the same.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 判断child类型，选择对应的创建函数</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> isUnkeyedTopLevelFragment </span><span style="color:#D73A49">=</span></span>
<span data-line=""><span style="color:#D73A49">      typeof</span><span style="color:#24292E"> newChild </span><span style="color:#D73A49">===</span><span style="color:#032F62"> &#x27;object&#x27;</span><span style="color:#D73A49"> &amp;&amp;</span></span>
<span data-line=""><span style="color:#24292E">      newChild </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#D73A49"> &amp;&amp;</span></span>
<span data-line=""><span style="color:#24292E">      newChild.type </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> REACT_FRAGMENT_TYPE</span><span style="color:#D73A49"> &amp;&amp;</span></span>
<span data-line=""><span style="color:#24292E">      newChild.key </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (isUnkeyedTopLevelFragment) {</span></span>
<span data-line=""><span style="color:#24292E">      newChild </span><span style="color:#D73A49">=</span><span style="color:#24292E"> newChild.props.children</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#6A737D">// Handle object types</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> isObject </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> typeof</span><span style="color:#24292E"> newChild </span><span style="color:#D73A49">===</span><span style="color:#032F62"> &#x27;object&#x27;</span><span style="color:#D73A49"> &amp;&amp;</span><span style="color:#24292E"> newChild </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (isObject) {</span></span>
<span data-line=""><span style="color:#D73A49">      switch</span><span style="color:#24292E"> (</span></span>
<span data-line=""><span style="color:#24292E">        newChild.$typeof </span><span style="color:#6A737D">// 判断$typeof，mountdiv时进入此处</span></span>
<span data-line=""><span style="color:#24292E">      ) {</span></span>
<span data-line=""><span style="color:#D73A49">        case</span><span style="color:#005CC5"> REACT_ELEMENT_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#D73A49">          return</span><span style="color:#6F42C1"> placeSingleChild</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#6F42C1">            reconcileSingleElement</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">              returnFiber,</span></span>
<span data-line=""><span style="color:#24292E">              currentFirstChild,</span></span>
<span data-line=""><span style="color:#24292E">              newChild,</span></span>
<span data-line=""><span style="color:#24292E">              lanes,</span></span>
<span data-line=""><span style="color:#24292E">            ),</span></span>
<span data-line=""><span style="color:#24292E">          )</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">        case</span><span style="color:#005CC5"> REACT_PORTAL_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#D73A49">          return</span><span style="color:#6F42C1"> placeSingleChild</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#6F42C1">            reconcileSinglePortal</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">              returnFiber,</span></span>
<span data-line=""><span style="color:#24292E">              currentFirstChild,</span></span>
<span data-line=""><span style="color:#24292E">              newChild,</span></span>
<span data-line=""><span style="color:#24292E">              lanes,</span></span>
<span data-line=""><span style="color:#24292E">            ),</span></span>
<span data-line=""><span style="color:#24292E">          )</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">        case</span><span style="color:#005CC5"> REACT_LAZY_TYPE</span><span style="color:#24292E">: {</span></span>
<span data-line=""><span style="color:#D73A49">          var</span><span style="color:#24292E"> payload </span><span style="color:#D73A49">=</span><span style="color:#24292E"> newChild._payload</span></span>
<span data-line=""><span style="color:#D73A49">          var</span><span style="color:#24292E"> init </span><span style="color:#D73A49">=</span><span style="color:#24292E"> newChild._init </span><span style="color:#6A737D">// TODO: This function is supposed to be non-recursive.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">          return</span><span style="color:#6F42C1"> reconcileChildFibers</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">            returnFiber,</span></span>
<span data-line=""><span style="color:#24292E">            currentFirstChild,</span></span>
<span data-line=""><span style="color:#6F42C1">            init</span><span style="color:#24292E">(payload),</span></span>
<span data-line=""><span style="color:#24292E">            lanes,</span></span>
<span data-line=""><span style="color:#24292E">          )</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">typeof</span><span style="color:#24292E"> newChild </span><span style="color:#D73A49">===</span><span style="color:#032F62"> &#x27;string&#x27;</span><span style="color:#D73A49"> ||</span><span style="color:#D73A49"> typeof</span><span style="color:#24292E"> newChild </span><span style="color:#D73A49">===</span><span style="color:#032F62"> &#x27;number&#x27;</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#6F42C1"> placeSingleChild</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#6F42C1">        reconcileSingleTextNode</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">          returnFiber,</span></span>
<span data-line=""><span style="color:#24292E">          currentFirstChild,</span></span>
<span data-line=""><span style="color:#032F62">          &#x27;&#x27;</span><span style="color:#D73A49"> +</span><span style="color:#24292E"> newChild,</span></span>
<span data-line=""><span style="color:#24292E">          lanes,</span></span>
<span data-line=""><span style="color:#24292E">        ),</span></span>
<span data-line=""><span style="color:#24292E">      )</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (</span><span style="color:#6F42C1">isArray$1</span><span style="color:#24292E">(newChild)) {</span></span>
<span data-line=""><span style="color:#D73A49">      return</span><span style="color:#6F42C1"> reconcileChildrenArray</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">        returnFiber,</span></span>
<span data-line=""><span style="color:#24292E">        currentFirstChild,</span></span>
<span data-line=""><span style="color:#24292E">        newChild,</span></span>
<span data-line=""><span style="color:#24292E">        lanes,</span></span>
<span data-line=""><span style="color:#24292E">      )</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // 省略部分情况</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    return</span><span style="color:#6F42C1"> deleteRemainingChildren</span><span style="color:#24292E">(returnFiber, currentFirstChild)</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  return</span><span style="color:#24292E"> reconcileChildFibers</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure>
<h5 id="createfiberfromelement"><a class="autolink-headings" href="#createfiberfromelement"><span style="margin-right:4px">#</span></a>createFiberFromElement</h5>
<p>根据 react element 创建 fiber</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> createFiberFromElement</span><span style="color:#24292E">(</span><span style="color:#E36209">element</span><span style="color:#24292E">, </span><span style="color:#E36209">mode</span><span style="color:#24292E">, </span><span style="color:#E36209">lanes</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> owner </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">  {</span></span>
<span data-line=""><span style="color:#24292E">    owner </span><span style="color:#D73A49">=</span><span style="color:#24292E"> element._owner</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> type </span><span style="color:#D73A49">=</span><span style="color:#24292E"> element.type</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> key </span><span style="color:#D73A49">=</span><span style="color:#24292E"> element.key</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> pendingProps </span><span style="color:#D73A49">=</span><span style="color:#24292E"> element.props</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> fiber </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> createFiberFromTypeAndProps</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">    type,</span></span>
<span data-line=""><span style="color:#24292E">    key,</span></span>
<span data-line=""><span style="color:#24292E">    pendingProps,</span></span>
<span data-line=""><span style="color:#24292E">    owner,</span></span>
<span data-line=""><span style="color:#24292E">    mode,</span></span>
<span data-line=""><span style="color:#24292E">    lanes,</span></span>
<span data-line=""><span style="color:#24292E">  )</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">  {</span></span>
<span data-line=""><span style="color:#24292E">    fiber._debugSource </span><span style="color:#D73A49">=</span><span style="color:#24292E"> element._source</span></span>
<span data-line=""><span style="color:#24292E">    fiber._debugOwner </span><span style="color:#D73A49">=</span><span style="color:#24292E"> element._owner</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  return</span><span style="color:#24292E"> fiber</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure>
<h5 id="createfiberfromtypeandprops"><a class="autolink-headings" href="#createfiberfromtypeandprops"><span style="margin-right:4px">#</span></a>createFiberFromTypeAndProps</h5>
<p>根据 type 和 props 属性创建 fiber</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> createFiberFromTypeAndProps</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#E36209">  type</span><span style="color:#24292E">, </span><span style="color:#6A737D">// React$ElementType</span></span>
<span data-line=""><span style="color:#E36209">  key</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">  pendingProps</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">  owner</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">  mode</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#E36209">  lanes</span><span style="color:#24292E">,</span></span>
<span data-line=""><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> fiberTag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> IndeterminateComponent </span><span style="color:#6A737D">// The resolved type is set if we know what the final type will be. I.e. it&#x27;s not lazy.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> resolvedType </span><span style="color:#D73A49">=</span><span style="color:#24292E"> type</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 根据type类型添加fiber标记</span></span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">typeof</span><span style="color:#24292E"> type </span><span style="color:#D73A49">===</span><span style="color:#032F62"> &#x27;function&#x27;</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (</span><span style="color:#6F42C1">shouldConstruct$1</span><span style="color:#24292E">(type)) {</span></span>
<span data-line=""><span style="color:#24292E">      fiberTag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> ClassComponent</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">      {</span></span>
<span data-line=""><span style="color:#24292E">        resolvedType </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> resolveClassForHotReloading</span><span style="color:#24292E">(resolvedType)</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#24292E">      {</span></span>
<span data-line=""><span style="color:#24292E">        resolvedType </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> resolveFunctionForHotReloading</span><span style="color:#24292E">(resolvedType)</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  } </span><span style="color:#D73A49">else</span><span style="color:#D73A49"> if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">typeof</span><span style="color:#24292E"> type </span><span style="color:#D73A49">===</span><span style="color:#032F62"> &#x27;string&#x27;</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#24292E">    fiberTag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> HostComponent</span></span>
<span data-line=""><span style="color:#24292E">  } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6F42C1">    getTag</span><span style="color:#24292E">: </span><span style="color:#D73A49">switch</span><span style="color:#24292E"> (type) {</span></span>
<span data-line=""><span style="color:#D73A49">      case</span><span style="color:#005CC5"> REACT_FRAGMENT_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#D73A49">        return</span><span style="color:#6F42C1"> createFiberFromFragment</span><span style="color:#24292E">(pendingProps.children, mode, lanes, key)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      case</span><span style="color:#005CC5"> REACT_DEBUG_TRACING_MODE_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#24292E">        fiberTag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> Mode</span></span>
<span data-line=""><span style="color:#24292E">        mode </span><span style="color:#D73A49">|=</span><span style="color:#24292E"> DebugTracingMode</span></span>
<span data-line=""><span style="color:#D73A49">        break</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      case</span><span style="color:#005CC5"> REACT_STRICT_MODE_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#24292E">        fiberTag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> Mode</span></span>
<span data-line=""><span style="color:#24292E">        mode </span><span style="color:#D73A49">|=</span><span style="color:#24292E"> StrictMode</span></span>
<span data-line=""><span style="color:#D73A49">        break</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      case</span><span style="color:#005CC5"> REACT_PROFILER_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#D73A49">        return</span><span style="color:#6F42C1"> createFiberFromProfiler</span><span style="color:#24292E">(pendingProps, mode, lanes, key)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      case</span><span style="color:#005CC5"> REACT_SUSPENSE_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#D73A49">        return</span><span style="color:#6F42C1"> createFiberFromSuspense</span><span style="color:#24292E">(pendingProps, mode, lanes, key)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      case</span><span style="color:#005CC5"> REACT_SUSPENSE_LIST_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#D73A49">        return</span><span style="color:#6F42C1"> createFiberFromSuspenseList</span><span style="color:#24292E">(pendingProps, mode, lanes, key)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      case</span><span style="color:#005CC5"> REACT_OFFSCREEN_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#D73A49">        return</span><span style="color:#6F42C1"> createFiberFromOffscreen</span><span style="color:#24292E">(pendingProps, mode, lanes, key)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      case</span><span style="color:#005CC5"> REACT_LEGACY_HIDDEN_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#D73A49">        return</span><span style="color:#6F42C1"> createFiberFromLegacyHidden</span><span style="color:#24292E">(pendingProps, mode, lanes, key)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      case</span><span style="color:#005CC5"> REACT_SCOPE_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">      // eslint-disable-next-line no-fallthrough</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      default</span><span style="color:#24292E">: {</span></span>
<span data-line=""><span style="color:#D73A49">        if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">typeof</span><span style="color:#24292E"> type </span><span style="color:#D73A49">===</span><span style="color:#032F62"> &#x27;object&#x27;</span><span style="color:#D73A49"> &amp;&amp;</span><span style="color:#24292E"> type </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">          switch</span><span style="color:#24292E"> (type.$typeof) {</span></span>
<span data-line=""><span style="color:#D73A49">            case</span><span style="color:#005CC5"> REACT_PROVIDER_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#24292E">              fiberTag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> ContextProvider</span></span>
<span data-line=""><span style="color:#D73A49">              break</span><span style="color:#6F42C1"> getTag</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">            case</span><span style="color:#005CC5"> REACT_CONTEXT_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#6A737D">              // This is a consumer</span></span>
<span data-line=""><span style="color:#24292E">              fiberTag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> ContextConsumer</span></span>
<span data-line=""><span style="color:#D73A49">              break</span><span style="color:#6F42C1"> getTag</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">            case</span><span style="color:#005CC5"> REACT_FORWARD_REF_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#24292E">              fiberTag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> ForwardRef</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">              {</span></span>
<span data-line=""><span style="color:#24292E">                resolvedType </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> resolveForwardRefForHotReloading</span><span style="color:#24292E">(resolvedType)</span></span>
<span data-line=""><span style="color:#24292E">              }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">              break</span><span style="color:#6F42C1"> getTag</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">            case</span><span style="color:#005CC5"> REACT_MEMO_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#24292E">              fiberTag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> MemoComponent</span></span>
<span data-line=""><span style="color:#D73A49">              break</span><span style="color:#6F42C1"> getTag</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">            case</span><span style="color:#005CC5"> REACT_LAZY_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#24292E">              fiberTag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> LazyComponent</span></span>
<span data-line=""><span style="color:#24292E">              resolvedType </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#D73A49">              break</span><span style="color:#6F42C1"> getTag</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">            case</span><span style="color:#005CC5"> REACT_BLOCK_TYPE</span><span style="color:#24292E">:</span></span>
<span data-line=""><span style="color:#24292E">              fiberTag </span><span style="color:#D73A49">=</span><span style="color:#24292E"> Block</span></span>
<span data-line=""><span style="color:#D73A49">              break</span><span style="color:#6F42C1"> getTag</span></span>
<span data-line=""><span style="color:#24292E">          }</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">        var</span><span style="color:#24292E"> info </span><span style="color:#D73A49">=</span><span style="color:#032F62"> &#x27;&#x27;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">        {</span></span>
<span data-line=""><span style="color:#D73A49">          if</span><span style="color:#24292E"> (</span></span>
<span data-line=""><span style="color:#24292E">            type </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> undefined</span><span style="color:#D73A49"> ||</span></span>
<span data-line=""><span style="color:#24292E">            (</span><span style="color:#D73A49">typeof</span><span style="color:#24292E"> type </span><span style="color:#D73A49">===</span><span style="color:#032F62"> &#x27;object&#x27;</span><span style="color:#D73A49"> &amp;&amp;</span></span>
<span data-line=""><span style="color:#24292E">              type </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#D73A49"> &amp;&amp;</span></span>
<span data-line=""><span style="color:#24292E">              Object.</span><span style="color:#6F42C1">keys</span><span style="color:#24292E">(type).</span><span style="color:#005CC5">length</span><span style="color:#D73A49"> ===</span><span style="color:#005CC5"> 0</span><span style="color:#24292E">)</span></span>
<span data-line=""><span style="color:#24292E">          ) {</span></span>
<span data-line=""><span style="color:#24292E">            info </span><span style="color:#D73A49">+=</span></span>
<span data-line=""><span style="color:#032F62">              &#x27; You likely forgot to export your component from the file &#x27;</span><span style="color:#D73A49"> +</span></span>
<span data-line=""><span style="color:#032F62">              &quot;it&#x27;s defined in, or you might have mixed up default and &quot;</span><span style="color:#D73A49"> +</span></span>
<span data-line=""><span style="color:#032F62">              &#x27;named imports.&#x27;</span></span>
<span data-line=""><span style="color:#24292E">          }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">          var</span><span style="color:#24292E"> ownerName </span><span style="color:#D73A49">=</span><span style="color:#24292E"> owner </span><span style="color:#D73A49">?</span><span style="color:#6F42C1"> getComponentName</span><span style="color:#24292E">(owner.type) </span><span style="color:#D73A49">:</span><span style="color:#005CC5"> null</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">          if</span><span style="color:#24292E"> (ownerName) {</span></span>
<span data-line=""><span style="color:#24292E">            info </span><span style="color:#D73A49">+=</span><span style="color:#032F62"> &#x27;</span><span style="color:#005CC5">\n\n</span><span style="color:#032F62">Check the render method of `&#x27;</span><span style="color:#D73A49"> +</span><span style="color:#24292E"> ownerName </span><span style="color:#D73A49">+</span><span style="color:#032F62"> &#x27;`.&#x27;</span></span>
<span data-line=""><span style="color:#24292E">          }</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">        {</span></span>
<span data-line=""><span style="color:#24292E">          {</span></span>
<span data-line=""><span style="color:#D73A49">            throw</span><span style="color:#6F42C1"> Error</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#032F62">              &#x27;Element type is invalid: expected a string (for built-in components) or a class/function (for composite components) but got: &#x27;</span><span style="color:#D73A49"> +</span></span>
<span data-line=""><span style="color:#24292E">                (type </span><span style="color:#D73A49">==</span><span style="color:#005CC5"> null</span><span style="color:#D73A49"> ?</span><span style="color:#24292E"> type </span><span style="color:#D73A49">:</span><span style="color:#D73A49"> typeof</span><span style="color:#24292E"> type) </span><span style="color:#D73A49">+</span></span>
<span data-line=""><span style="color:#032F62">                &#x27;.&#x27;</span><span style="color:#D73A49"> +</span></span>
<span data-line=""><span style="color:#24292E">                info,</span></span>
<span data-line=""><span style="color:#24292E">            )</span></span>
<span data-line=""><span style="color:#24292E">          }</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> fiber </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> createFiber</span><span style="color:#24292E">(fiberTag, pendingProps, key, mode)</span></span>
<span data-line=""><span style="color:#24292E">  fiber.elementType </span><span style="color:#D73A49">=</span><span style="color:#24292E"> type</span></span>
<span data-line=""><span style="color:#24292E">  fiber.type </span><span style="color:#D73A49">=</span><span style="color:#24292E"> resolvedType</span></span>
<span data-line=""><span style="color:#24292E">  fiber.lanes </span><span style="color:#D73A49">=</span><span style="color:#24292E"> lanes</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">  {</span></span>
<span data-line=""><span style="color:#24292E">    fiber._debugOwner </span><span style="color:#D73A49">=</span><span style="color:#24292E"> owner</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  return</span><span style="color:#24292E"> fiber</span></span>
<span data-line=""><span style="color:#24292E">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">//---</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">var</span><span style="color:#6F42C1"> createFiber</span><span style="color:#D73A49"> =</span><span style="color:#D73A49"> function</span><span style="color:#24292E"> (</span><span style="color:#E36209">tag</span><span style="color:#24292E">, </span><span style="color:#E36209">pendingProps</span><span style="color:#24292E">, </span><span style="color:#E36209">key</span><span style="color:#24292E">, </span><span style="color:#E36209">mode</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">  // $FlowFixMe: the shapes are exact here but Flow doesn&#x27;t like constructors</span></span>
<span data-line=""><span style="color:#D73A49">  return</span><span style="color:#D73A49"> new</span><span style="color:#6F42C1"> FiberNode</span><span style="color:#24292E">(tag, pendingProps, key, mode)</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure></div><footer class="mt-[32px]"><div class="border-divider flex justify-between border-t pt-[24px]"><div class="w-[calc(50%-4px)]"><a class="cursor-pointer border-divider hover:border-brand group block h-full w-full rounded-[8px] border px-[16px] py-[8px] transition-colors duration-300"><div class="text-text-2 text-[12px] font-[500] leading-[20px]">上一页</div><div class=" text-text-2 group-hover:text-brand overflow-hidden text-ellipsis whitespace-nowrap text-[14px] font-[500] leading-[20px] transition-colors duration-300">流程</div></a></div><div class="w-[calc(50%-4px)]"><a class="cursor-pointer border-divider hover:border-brand group block h-full w-full rounded-[8px] border px-[16px] py-[8px] transition-colors duration-300"><div class="text-text-2 text-[12px] font-[500] leading-[20px]">下一页</div><div class=" text-text-2 group-hover:text-brand overflow-hidden text-ellipsis whitespace-nowrap text-[14px] font-[500] leading-[20px] transition-colors duration-300">mount阶段的completeWork</div></a></div></div></footer></div></div><aside class="w-toc full:flex sticky top-[calc(theme(spacing.nav)+48px)] hidden h-full flex-col"><div class="border-divider pc:border-l px-[16px] font-[500]"><div class="pc:block bg-brand absolute left-0 hidden h-[18px] w-px transition-[opacity,top] duration-300" style="top:33px;opacity:0"></div><div class="text-[14px] font-[600] leading-[28px]">本页目录</div><div><div><a href="#先从-indexjs-开始" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">先从 index.js 开始</a></div><div><a href="#render" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">render()</a></div><div><a href="#legacyrendersubtreeintocontainer" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:1rem">legacyRenderSubtreeIntoContainer()</a></div><div><a href="#legacycreaterootfromdomcontainer" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:2rem">legacyCreateRootFromDOMContainer()</a></div><div><a href="#createworkinprogress" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">createWorkInProgress</a></div><div><a href="#beginwork" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">beginWork()</a></div><div><a href="#updatehostcomponent" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:0rem">updateHostComponent()</a></div><div><a href="#reconcilechildren" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:1rem">reconcileChildren()</a></div><div><a href="#childreconciler" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:2rem">ChildReconciler()</a></div><div><a href="#createfiberfromelement" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:3rem">createFiberFromElement</a></div><div><a href="#createfiberfromtypeandprops" class="text-text-2 text-hover block overflow-hidden text-ellipsis whitespace-nowrap text-[13px] leading-[28px]" style="padding-left:3rem">createFiberFromTypeAndProps</a></div></div></div></aside></div></div></div>
  
    <script type="module" src="/client-entry.js"></script>
    </body>
    
</html>
