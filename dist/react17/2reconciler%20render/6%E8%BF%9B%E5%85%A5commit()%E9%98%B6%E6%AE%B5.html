<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1.0,user-scalable=no"
    />
    <title>ZEROPRESS</title>
  <link rel="stylesheet" href="/assets/client-entry-CfIYQ-JS.css">
  <body>
    <div id="root"><header class="pc:fixed absolute left-0 top-0 z-30 w-full"><div class="border-divider bg-bg-default pc:block h-nav hidden border-b px-[12px] pt-px transition-colors duration-300"><div class="flex h-full items-center justify-between"><div class="flex h-full shrink-0 justify-start"><div class="h-full"><nav class="mx-[12px] flex h-full items-center"><a class="cursor-pointer"><img src="/logo.jpg" class="h-[24px] w-[24px]"/></a></nav></div></div><div class="flex h-full justify-end"><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">http</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-brand text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">react17</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">数据结构与算法</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">设计模式</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">笔记</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">总结</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">收集</a></nav></div><div class="h-full"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">业务</a></nav></div><div class="h-full"><nav class="mx-[4px] flex h-full items-center"><button class="bg-bg-switch border-divider hover:border-gray-1 relative h-[22px] w-[40px] rounded-[11px] border transition-colors duration-300"><div class="bg-bg-inverse shadow-1 absolute left-px top-px h-[18px] w-[18px] overflow-hidden rounded-[50%] transition-all duration-300 dark:translate-x-[18px]"><span class="*:text-text-2 *:absolute *:left-[3px] *:top-[3px] *:h-[12px] *:w-[12px] *:transition-opacity *:duration-300"><div class="icon-[carbon--sun] opacity-100 dark:opacity-0"></div><div class="icon-[carbon--moon] opacity-0 dark:opacity-100"></div></span></div></button></nav></div><div class="h-full"><nav class="mx-[12px] h-full"><a href="https://github.com/houhongxu/hhxpress" class="cursor-pointer text-text-2 text-hover flex  h-full items-center"><span class="icon-[carbon--logo-github] h-[24px] w-[24px]"></span></a></nav></div></div></div></div><div class="pc:hidden"><div class="h-nav bg-bg-default border-b px-[12px] pt-px"><div class="flex h-full items-center justify-between"><div class="flex h-full shrink-0 justify-start"><div class="h-full"><nav class="mx-[12px] flex h-full items-center"><a class="cursor-pointer"><img src="/logo.jpg" class="h-[24px] w-[24px]"/></a></nav></div></div><div class="flex h-full items-center justify-end"><div class="icon-[carbon--list] h-[24px] w-[24px] cursor-pointer"></div></div></div></div></div></header><div class="invisible opacity-0 bg-bg-default mt-nav fixed inset-0 z-50 transition-opacity duration-300"><div class="mt-[12px]"><div class="flex items-center justify-center py-[4px]"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">http</a></nav></div><div class="flex items-center justify-center py-[4px]"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-brand text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">react17</a></nav></div><div class="flex items-center justify-center py-[4px]"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">数据结构与算法</a></nav></div><div class="flex items-center justify-center py-[4px]"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">设计模式</a></nav></div><div class="flex items-center justify-center py-[4px]"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">笔记</a></nav></div><div class="flex items-center justify-center py-[4px]"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">总结</a></nav></div><div class="flex items-center justify-center py-[4px]"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">收集</a></nav></div><div class="flex items-center justify-center py-[4px]"><nav class="mx-[12px] h-full justify-end"><a class="cursor-pointer text-text-2 text-hover flex h-full items-center whitespace-nowrap text-[14px] font-[500]">业务</a></nav></div><div class="flex items-center justify-center py-[4px]"><nav class="mx-[4px] flex h-full items-center"><button class="bg-bg-switch border-divider hover:border-gray-1 relative h-[22px] w-[40px] rounded-[11px] border transition-colors duration-300"><div class="bg-bg-inverse shadow-1 absolute left-px top-px h-[18px] w-[18px] overflow-hidden rounded-[50%] transition-all duration-300 dark:translate-x-[18px]"><span class="*:text-text-2 *:absolute *:left-[3px] *:top-[3px] *:h-[12px] *:w-[12px] *:transition-opacity *:duration-300"><div class="icon-[carbon--sun] opacity-100 dark:opacity-0"></div><div class="icon-[carbon--moon] opacity-0 dark:opacity-100"></div></span></div></button></nav></div><div class="flex items-center justify-center py-[4px]"><nav class="mx-[12px] h-full"><a href="https://github.com/houhongxu/hhxpress" class="cursor-pointer text-text-2 text-hover flex  h-full items-center"><span class="icon-[carbon--logo-github] h-[24px] w-[24px]"></span></a></nav></div></div></div><div class="pt-nav"><aside class="mt-nav w-sidebar border-divider bg-bg-sidebar pc:-translate-x-0 fixed inset-y-0 left-0 -translate-x-full overflow-y-auto border-r px-[28px] py-[16px] transition-transform duration-300"><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>intro</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:108px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">流程</a><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">架构</a><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">fiber</a><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">jsx</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>reconciler render</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:162px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">流程</a><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">mount阶段的beginWork</a><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">mount阶段的completeWork</a><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">update阶段的beginWork</a><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">update阶段的completeWork</a><a class="cursor-pointer text-brand text-hover text-overflow mb-[2px] p-[2px] text-[14px]">进入commit()阶段</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>reconciler commit</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:27px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">流程</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><a class="cursor-pointer">readme</a></h2></div></aside><div class="pc:ml-sidebar ml-0 flex justify-between"><div class="mx-auto w-full max-w-[768px] transition-[margin] duration-300"><div class="h-nav pc:hidden bg-bg-default sticky top-0 z-40 w-full border-b"><div class="flex h-full items-center justify-between px-[24px]"><a class="icon-[carbon--container-image] h-[24px] w-[24px] cursor-pointer"></a><a class="icon-[carbon--border-top] h-[24px] w-[24px] cursor-pointer"></a></div><div class="fixed inset-0 bg-[#00000060] transition-all duration-300 opacity-0 invisible"></div><aside class="w-sidebar border-divider bg-bg-sidebar fixed inset-y-0 left-0 overflow-y-auto border-r px-[28px] py-[16px] transition-transform duration-300 -translate-x-full"><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>intro</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:108px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">流程</a><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">架构</a><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">fiber</a><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">jsx</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>reconciler render</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:162px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">流程</a><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">mount阶段的beginWork</a><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">mount阶段的completeWork</a><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">update阶段的beginWork</a><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">update阶段的completeWork</a><a class="cursor-pointer text-brand text-hover text-overflow mb-[2px] p-[2px] text-[14px]">进入commit()阶段</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><span>reconciler commit</span><span class="rotate-90 icon-[carbon--chevron-right] transition-transform duration-300"></span></h2><div style="height:27px" class="mb-[12px] flex flex-col overflow-hidden pl-[1rem] transition-[height] duration-300"><a class="cursor-pointer text-text-2 text-hover text-overflow mb-[2px] p-[2px] text-[14px]">流程</a></div></div><div class="border-divider mt-[4px] border-t first:mt-0 first:border-t-0"><h2 class="text-text-1 mb-[6px] mt-[12px] flex cursor-pointer items-center justify-between font-[700]"><a class="cursor-pointer">readme</a></h2></div></aside><div class="fixed inset-0 bg-[#00000060] transition-all duration-300 opacity-0 invisible"></div><aside class="w-toc border-divider bg-bg-sidebar fixed inset-y-0 right-0 h-full border-l px-[28px] py-[16px] transition-transform duration-300 translate-x-full"><div class="border-divider pc:border-l px-[16px] font-[500]"><div class="pc:block bg-brand absolute left-0 hidden h-[18px] w-px transition-[opacity,top] duration-300" style="top:33px;opacity:0"></div><div class="text-[14px] font-[600] leading-[28px]">本页目录</div><div><div><a href="#completeunitofwork" class="text-text-2 text-hover text-overflow block text-[13px] leading-[28px]" style="padding-left:0rem">completeUnitOfWork</a></div></div></div></aside></div><div class="p-[48px]"><div class="doc"><h1 id="进入-commit阶段"><a class="autolink-headings" href="#进入-commit阶段"><span style="margin-right:4px">#</span></a>进入 commit()阶段</h1>
<p>执行完 render()阶段后，将回到 performSyncWorkOnRoot，执行底部的 commitRoot()</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> performSyncWorkOnRoot</span><span style="color:#24292E">(</span><span style="color:#E36209">root</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (</span><span style="color:#D73A49">!</span><span style="color:#24292E">((executionContext </span><span style="color:#D73A49">&amp;</span><span style="color:#24292E"> (RenderContext </span><span style="color:#D73A49">|</span><span style="color:#24292E"> CommitContext)) </span><span style="color:#D73A49">===</span><span style="color:#24292E"> NoContext)) {</span></span>
<span data-line=""><span style="color:#24292E">    {</span></span>
<span data-line=""><span style="color:#D73A49">      throw</span><span style="color:#6F42C1"> Error</span><span style="color:#24292E">(</span><span style="color:#032F62">&#x27;Should not already be working.&#x27;</span><span style="color:#24292E">)</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6F42C1">  flushPassiveEffects</span><span style="color:#24292E">()</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> lanes</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> exitStatus</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (</span></span>
<span data-line=""><span style="color:#24292E">    root </span><span style="color:#D73A49">===</span><span style="color:#24292E"> workInProgressRoot </span><span style="color:#D73A49">&amp;&amp;</span></span>
<span data-line=""><span style="color:#6F42C1">    includesSomeLane</span><span style="color:#24292E">(root.expiredLanes, workInProgressRootRenderLanes)</span></span>
<span data-line=""><span style="color:#24292E">  ) {</span></span>
<span data-line=""><span style="color:#6A737D">    // There&#x27;s a partial tree, and at least one of its lanes has expired. Finish</span></span>
<span data-line=""><span style="color:#6A737D">    // rendering it before rendering the rest of the expired work.</span></span>
<span data-line=""><span style="color:#24292E">    lanes </span><span style="color:#D73A49">=</span><span style="color:#24292E"> workInProgressRootRenderLanes</span></span>
<span data-line=""><span style="color:#24292E">    exitStatus </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> renderRootSync</span><span style="color:#24292E">(root, lanes)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (</span></span>
<span data-line=""><span style="color:#6F42C1">      includesSomeLane</span><span style="color:#24292E">(</span></span>
<span data-line=""><span style="color:#24292E">        workInProgressRootIncludedLanes,</span></span>
<span data-line=""><span style="color:#24292E">        workInProgressRootUpdatedLanes,</span></span>
<span data-line=""><span style="color:#24292E">      )</span></span>
<span data-line=""><span style="color:#24292E">    ) {</span></span>
<span data-line=""><span style="color:#6A737D">      // The render included lanes that were updated during the render phase.</span></span>
<span data-line=""><span style="color:#6A737D">      // For example, when unhiding a hidden tree, we include all the lanes</span></span>
<span data-line=""><span style="color:#6A737D">      // that were previously skipped when the tree was hidden. That set of</span></span>
<span data-line=""><span style="color:#6A737D">      // lanes is a superset of the lanes we started rendering with.</span></span>
<span data-line=""><span style="color:#6A737D">      //</span></span>
<span data-line=""><span style="color:#6A737D">      // Note that this only happens when part of the tree is rendered</span></span>
<span data-line=""><span style="color:#6A737D">      // concurrently. If the whole tree is rendered synchronously, then there</span></span>
<span data-line=""><span style="color:#6A737D">      // are no interleaved events.</span></span>
<span data-line=""><span style="color:#24292E">      lanes </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> getNextLanes</span><span style="color:#24292E">(root, lanes)</span></span>
<span data-line=""><span style="color:#24292E">      exitStatus </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> renderRootSync</span><span style="color:#24292E">(root, lanes)</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#24292E">    lanes </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> getNextLanes</span><span style="color:#24292E">(root, NoLanes)</span></span>
<span data-line=""><span style="color:#24292E">    exitStatus </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> renderRootSync</span><span style="color:#24292E">(root, lanes)</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (root.tag </span><span style="color:#D73A49">!==</span><span style="color:#24292E"> LegacyRoot </span><span style="color:#D73A49">&amp;&amp;</span><span style="color:#24292E"> exitStatus </span><span style="color:#D73A49">===</span><span style="color:#24292E"> RootErrored) {</span></span>
<span data-line=""><span style="color:#24292E">    executionContext </span><span style="color:#D73A49">|=</span><span style="color:#24292E"> RetryAfterError </span><span style="color:#6A737D">// If an error occurred during hydration,</span></span>
<span data-line=""><span style="color:#6A737D">    // discard server response and fall back to client side render.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (root.hydrate) {</span></span>
<span data-line=""><span style="color:#24292E">      root.hydrate </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> false</span></span>
<span data-line=""><span style="color:#6F42C1">      clearContainer</span><span style="color:#24292E">(root.containerInfo)</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#6A737D">// If something threw an error, try rendering one more time. We&#x27;ll render</span></span>
<span data-line=""><span style="color:#6A737D">    // synchronously to block concurrent data mutations, and we&#x27;ll includes</span></span>
<span data-line=""><span style="color:#6A737D">    // all pending updates are included. If it still fails after the second</span></span>
<span data-line=""><span style="color:#6A737D">    // attempt, we&#x27;ll give up and commit the resulting tree.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">    lanes </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> getLanesToRetrySynchronouslyOnError</span><span style="color:#24292E">(root)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (lanes </span><span style="color:#D73A49">!==</span><span style="color:#24292E"> NoLanes) {</span></span>
<span data-line=""><span style="color:#24292E">      exitStatus </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> renderRootSync</span><span style="color:#24292E">(root, lanes)</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (exitStatus </span><span style="color:#D73A49">===</span><span style="color:#24292E"> RootFatalErrored) {</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> fatalError </span><span style="color:#D73A49">=</span><span style="color:#24292E"> workInProgressRootFatalError</span></span>
<span data-line=""><span style="color:#6F42C1">    prepareFreshStack</span><span style="color:#24292E">(root, NoLanes)</span></span>
<span data-line=""><span style="color:#6F42C1">    markRootSuspended$1</span><span style="color:#24292E">(root, lanes)</span></span>
<span data-line=""><span style="color:#6F42C1">    ensureRootIsScheduled</span><span style="color:#24292E">(root, </span><span style="color:#6F42C1">now</span><span style="color:#24292E">())</span></span>
<span data-line=""><span style="color:#D73A49">    throw</span><span style="color:#24292E"> fatalError</span></span>
<span data-line=""><span style="color:#24292E">  } </span><span style="color:#6A737D">// We now have a consistent tree. Because this is a sync render, we</span></span>
<span data-line=""><span style="color:#6A737D">  // will commit it even if something suspended.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> finishedWork </span><span style="color:#D73A49">=</span><span style="color:#24292E"> root.current.alternate</span></span>
<span data-line=""><span style="color:#24292E">  root.finishedWork </span><span style="color:#D73A49">=</span><span style="color:#24292E"> finishedWork</span></span>
<span data-line=""><span style="color:#24292E">  root.finishedLanes </span><span style="color:#D73A49">=</span><span style="color:#24292E"> lanes</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">  // 进入commit()阶段</span></span>
<span data-line=""><span style="color:#6F42C1">  commitRoot</span><span style="color:#24292E">(root) </span><span style="color:#6A737D">// Before exiting, make sure there&#x27;s a callback scheduled for the next</span></span>
<span data-line=""><span style="color:#6A737D">  // pending level.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6F42C1">  ensureRootIsScheduled</span><span style="color:#24292E">(root, </span><span style="color:#6F42C1">now</span><span style="color:#24292E">())</span></span>
<span data-line=""><span style="color:#D73A49">  return</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure>
<h2 id="completeunitofwork"><a class="autolink-headings" href="#completeunitofwork"><span style="margin-right:4px">#</span></a>completeUnitOfWork</h2>
<p>执行 render()阶段时，会将标记了 flags 的节点用链表链接</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display:grid"><span data-line=""><span style="color:#D73A49">function</span><span style="color:#6F42C1"> completeUnitOfWork</span><span style="color:#24292E">(</span><span style="color:#E36209">unitOfWork</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">  // Attempt to complete the current unit of work, then move to the next</span></span>
<span data-line=""><span style="color:#6A737D">  // sibling. If there are no more siblings, return to the parent fiber.</span></span>
<span data-line=""><span style="color:#D73A49">  var</span><span style="color:#24292E"> completedWork </span><span style="color:#D73A49">=</span><span style="color:#24292E"> unitOfWork</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  do</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6A737D">    // The current, flushed, state of this fiber is the alternate. Ideally</span></span>
<span data-line=""><span style="color:#6A737D">    // nothing should rely on this, but relying on it here means that we don&#x27;t</span></span>
<span data-line=""><span style="color:#6A737D">    // need an additional field on the work in progress.</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> current </span><span style="color:#D73A49">=</span><span style="color:#24292E"> completedWork.alternate</span></span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> returnFiber </span><span style="color:#D73A49">=</span><span style="color:#24292E"> completedWork.return </span><span style="color:#6A737D">// Check if the work completed or if something threw.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> ((completedWork.flags </span><span style="color:#D73A49">&amp;</span><span style="color:#24292E"> Incomplete) </span><span style="color:#D73A49">===</span><span style="color:#24292E"> NoFlags) {</span></span>
<span data-line=""><span style="color:#6F42C1">      setCurrentFiber</span><span style="color:#24292E">(completedWork)</span></span>
<span data-line=""><span style="color:#D73A49">      var</span><span style="color:#24292E"> next </span><span style="color:#D73A49">=</span><span style="color:#D73A49"> void</span><span style="color:#005CC5"> 0</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> ((completedWork.mode </span><span style="color:#D73A49">&amp;</span><span style="color:#24292E"> ProfileMode) </span><span style="color:#D73A49">===</span><span style="color:#24292E"> NoMode) {</span></span>
<span data-line=""><span style="color:#24292E">        next </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> completeWork</span><span style="color:#24292E">(current, completedWork, subtreeRenderLanes)</span></span>
<span data-line=""><span style="color:#24292E">      } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6F42C1">        startProfilerTimer</span><span style="color:#24292E">(completedWork)</span></span>
<span data-line=""><span style="color:#24292E">        next </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> completeWork</span><span style="color:#24292E">(current, completedWork, subtreeRenderLanes) </span><span style="color:#6A737D">// Update render duration assuming we didn&#x27;t error.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6F42C1">        stopProfilerTimerIfRunningAndRecordDelta</span><span style="color:#24292E">(completedWork, </span><span style="color:#005CC5">false</span><span style="color:#24292E">)</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6F42C1">      resetCurrentFiber</span><span style="color:#24292E">()</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (next </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">        // Completing this fiber spawned new work. Work on that next.</span></span>
<span data-line=""><span style="color:#24292E">        workInProgress </span><span style="color:#D73A49">=</span><span style="color:#24292E"> next</span></span>
<span data-line=""><span style="color:#D73A49">        return</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6F42C1">      resetChildLanes</span><span style="color:#24292E">(completedWork)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">      // ---</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">      // 根的firstEffect指向第一个含effectTag的节点</span></span>
<span data-line=""><span style="color:#6A737D">      // 含effectTag的节点的nextEffect指向最后一个</span></span>
<span data-line=""><span style="color:#6A737D">      // 根的lastEffect指向最后含effectTag的节点</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">      // completeWork为当前fiber</span></span>
<span data-line=""><span style="color:#6A737D">      // 假设</span></span>
<span data-line=""><span style="color:#6A737D">      // &lt;header&gt;</span></span>
<span data-line=""><span style="color:#6A737D">      //    &lt;p&gt;&lt;code&gt;&lt;/code&gt;&lt;/p&gt;</span></span>
<span data-line=""><span style="color:#6A737D">      //    &lt;a&gt;&lt;/a&gt;</span></span>
<span data-line=""><span style="color:#6A737D">      // &lt;/header&gt;</span></span>
<span data-line=""><span style="color:#6A737D">      // code在completeWork阶段时,returnFiber为p</span></span>
<span data-line=""><span style="color:#6A737D">      // 当code的兄弟节点报错时，p会被标记Incomplete，按位&amp;则会有1，不等于NoFlags</span></span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (</span></span>
<span data-line=""><span style="color:#24292E">        returnFiber </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#D73A49"> &amp;&amp;</span><span style="color:#6A737D"> // Do not append effects to parents if a sibling failed to complete</span></span>
<span data-line=""><span style="color:#24292E">        (returnFiber.flags </span><span style="color:#D73A49">&amp;</span><span style="color:#24292E"> Incomplete) </span><span style="color:#D73A49">===</span><span style="color:#24292E"> NoFlags</span></span>
<span data-line=""><span style="color:#24292E">      ) {</span></span>
<span data-line=""><span style="color:#6A737D">        // p存在且子节点未报错时</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">        // Append all the effects of the subtree and this fiber onto the effect</span></span>
<span data-line=""><span style="color:#6A737D">        // list of the parent. The completion order of the children affects the</span></span>
<span data-line=""><span style="color:#6A737D">        // side-effect order.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">        // p.firstEffect=null,header.firstEffect=code,div.firstEffect=code</span></span>
<span data-line=""><span style="color:#D73A49">        if</span><span style="color:#24292E"> (returnFiber.firstEffect </span><span style="color:#D73A49">===</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#24292E">          returnFiber.firstEffect </span><span style="color:#D73A49">=</span><span style="color:#24292E"> completedWork.firstEffect</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">        // header.lastEffect=code,div.lastEffect=p</span></span>
<span data-line=""><span style="color:#D73A49">        if</span><span style="color:#24292E"> (completedWork.lastEffect </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#D73A49">          if</span><span style="color:#24292E"> (returnFiber.lastEffect </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#24292E">            returnFiber.lastEffect.nextEffect </span><span style="color:#D73A49">=</span><span style="color:#24292E"> completedWork.firstEffect</span></span>
<span data-line=""><span style="color:#24292E">          }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">          returnFiber.lastEffect </span><span style="color:#D73A49">=</span><span style="color:#24292E"> completedWork.lastEffect</span></span>
<span data-line=""><span style="color:#24292E">        } </span><span style="color:#6A737D">// If this fiber had side-effects, we append it AFTER the children&#x27;s</span></span>
<span data-line=""><span style="color:#6A737D">        // side-effects. We can perform certain side-effects earlier if needed,</span></span>
<span data-line=""><span style="color:#6A737D">        // by doing multiple passes over the effect list. We don&#x27;t want to</span></span>
<span data-line=""><span style="color:#6A737D">        // schedule our own side-effect on our own list because if end up</span></span>
<span data-line=""><span style="color:#6A737D">        // reusing children we&#x27;ll schedule this effect onto itself since we&#x27;re</span></span>
<span data-line=""><span style="color:#6A737D">        // at the end.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">        var</span><span style="color:#24292E"> flags </span><span style="color:#D73A49">=</span><span style="color:#24292E"> completedWork.flags </span><span style="color:#6A737D">// Skip both NoWork and PerformedWork tags when creating the effect</span></span>
<span data-line=""><span style="color:#6A737D">        // list. PerformedWork effect is read by React DevTools but shouldn&#x27;t be</span></span>
<span data-line=""><span style="color:#6A737D">        // committed.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">        // 是否有标记</span></span>
<span data-line=""><span style="color:#D73A49">        if</span><span style="color:#24292E"> (flags </span><span style="color:#D73A49">&gt;</span><span style="color:#24292E"> PerformedWork) {</span></span>
<span data-line=""><span style="color:#6A737D">          // p.lastEffect是否存在</span></span>
<span data-line=""><span style="color:#D73A49">          if</span><span style="color:#24292E"> (returnFiber.lastEffect </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">            // 注意 这里是NEXTEffect</span></span>
<span data-line=""><span style="color:#6A737D">            // header.lastEffect.nextEffect(code)=p</span></span>
<span data-line=""><span style="color:#24292E">            returnFiber.lastEffect.nextEffect </span><span style="color:#D73A49">=</span><span style="color:#24292E"> completedWork</span></span>
<span data-line=""><span style="color:#24292E">          } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6A737D">            // p.firstEffect赋值为code</span></span>
<span data-line=""><span style="color:#24292E">            returnFiber.firstEffect </span><span style="color:#D73A49">=</span><span style="color:#24292E"> completedWork</span></span>
<span data-line=""><span style="color:#24292E">          }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">          // p.lastEffect赋值为code,header.lastEffect=p</span></span>
<span data-line=""><span style="color:#24292E">          returnFiber.lastEffect </span><span style="color:#D73A49">=</span><span style="color:#24292E"> completedWork</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""><span style="color:#6A737D">        // 之后进入p,a(无flags跳过),header,div</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#D73A49">else</span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6A737D">      // This fiber did not complete because something threw. Pop values off</span></span>
<span data-line=""><span style="color:#6A737D">      // the stack without entering the complete phase. If this is a boundary,</span></span>
<span data-line=""><span style="color:#6A737D">      // capture values if possible.</span></span>
<span data-line=""><span style="color:#D73A49">      var</span><span style="color:#24292E"> _next </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> unwindWork</span><span style="color:#24292E">(completedWork) </span><span style="color:#6A737D">// Because this fiber did not complete, don&#x27;t reset its expiration time.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (_next </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">        // If completing this work spawned new work, do that next. We&#x27;ll come</span></span>
<span data-line=""><span style="color:#6A737D">        // back here again.</span></span>
<span data-line=""><span style="color:#6A737D">        // Since we&#x27;re restarting, remove anything that is not a host effect</span></span>
<span data-line=""><span style="color:#6A737D">        // from the effect tag.</span></span>
<span data-line=""><span style="color:#24292E">        _next.flags </span><span style="color:#D73A49">&amp;=</span><span style="color:#24292E"> HostEffectMask</span></span>
<span data-line=""><span style="color:#24292E">        workInProgress </span><span style="color:#D73A49">=</span><span style="color:#24292E"> _next</span></span>
<span data-line=""><span style="color:#D73A49">        return</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> ((completedWork.mode </span><span style="color:#D73A49">&amp;</span><span style="color:#24292E"> ProfileMode) </span><span style="color:#D73A49">!==</span><span style="color:#24292E"> NoMode) {</span></span>
<span data-line=""><span style="color:#6A737D">        // Record the render duration for the fiber that errored.</span></span>
<span data-line=""><span style="color:#6F42C1">        stopProfilerTimerIfRunningAndRecordDelta</span><span style="color:#24292E">(completedWork, </span><span style="color:#005CC5">false</span><span style="color:#24292E">) </span><span style="color:#6A737D">// Include the time spent working on failed children before continuing.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">        var</span><span style="color:#24292E"> actualDuration </span><span style="color:#D73A49">=</span><span style="color:#24292E"> completedWork.actualDuration</span></span>
<span data-line=""><span style="color:#D73A49">        var</span><span style="color:#24292E"> child </span><span style="color:#D73A49">=</span><span style="color:#24292E"> completedWork.child</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">        while</span><span style="color:#24292E"> (child </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#24292E">          actualDuration </span><span style="color:#D73A49">+=</span><span style="color:#24292E"> child.actualDuration</span></span>
<span data-line=""><span style="color:#24292E">          child </span><span style="color:#D73A49">=</span><span style="color:#24292E"> child.sibling</span></span>
<span data-line=""><span style="color:#24292E">        }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">        completedWork.actualDuration </span><span style="color:#D73A49">=</span><span style="color:#24292E"> actualDuration</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">      if</span><span style="color:#24292E"> (returnFiber </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">        // Mark the parent fiber as incomplete and clear its effect list.</span></span>
<span data-line=""><span style="color:#24292E">        returnFiber.firstEffect </span><span style="color:#D73A49">=</span><span style="color:#24292E"> returnFiber.lastEffect </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> null</span></span>
<span data-line=""><span style="color:#24292E">        returnFiber.flags </span><span style="color:#D73A49">|=</span><span style="color:#24292E"> Incomplete</span></span>
<span data-line=""><span style="color:#24292E">      }</span></span>
<span data-line=""><span style="color:#24292E">    }</span></span>
<span data-line=""><span style="color:#6A737D">    // ---</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    var</span><span style="color:#24292E"> siblingFiber </span><span style="color:#D73A49">=</span><span style="color:#24292E"> completedWork.sibling</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">    if</span><span style="color:#24292E"> (siblingFiber </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#6A737D">      // If there is more work to do in this returnFiber, do that next.</span></span>
<span data-line=""><span style="color:#24292E">      workInProgress </span><span style="color:#D73A49">=</span><span style="color:#24292E"> siblingFiber</span></span>
<span data-line=""><span style="color:#D73A49">      return</span></span>
<span data-line=""><span style="color:#24292E">    } </span><span style="color:#6A737D">// Otherwise, return to the parent</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">    completedWork </span><span style="color:#D73A49">=</span><span style="color:#24292E"> returnFiber </span><span style="color:#6A737D">// Update the next thing we&#x27;re working on in case something throws.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#24292E">    workInProgress </span><span style="color:#D73A49">=</span><span style="color:#24292E"> completedWork</span></span>
<span data-line=""><span style="color:#24292E">  } </span><span style="color:#D73A49">while</span><span style="color:#24292E"> (completedWork </span><span style="color:#D73A49">!==</span><span style="color:#005CC5"> null</span><span style="color:#24292E">) </span><span style="color:#6A737D">// We&#x27;ve reached the root.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (workInProgressRootExitStatus </span><span style="color:#D73A49">===</span><span style="color:#24292E"> RootIncomplete) {</span></span>
<span data-line=""><span style="color:#24292E">    workInProgressRootExitStatus </span><span style="color:#D73A49">=</span><span style="color:#24292E"> RootCompleted</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""><span style="color:#24292E">}</span></span></code></pre></figure></div><footer class="mt-[32px]"><div class="border-divider flex justify-between border-t pt-[24px]"><div class="w-[calc(50%-4px)]"><a class="cursor-pointer border-divider hover:border-brand group block h-full w-full rounded-[8px] border px-[16px] py-[8px] transition-colors duration-300"><div class="text-text-2 text-[12px] font-[500] leading-[20px]">上一页</div><div class=" text-text-2 group-hover:text-brand text-overflow text-[14px] font-[500] leading-[20px] transition-colors duration-300">update阶段的completeWork</div></a></div><div class="w-[calc(50%-4px)]"><a class="cursor-pointer border-divider hover:border-brand group block h-full w-full rounded-[8px] border px-[16px] py-[8px] transition-colors duration-300"><div class="text-text-2 text-[12px] font-[500] leading-[20px]">下一页</div><div class=" text-text-2 group-hover:text-brand text-overflow text-[14px] font-[500] leading-[20px] transition-colors duration-300">流程</div></a></div></div></footer></div></div><aside class="w-toc full:flex sticky top-[calc(theme(spacing.nav)+48px)] hidden h-full flex-col"><div class="border-divider pc:border-l px-[16px] font-[500]"><div class="pc:block bg-brand absolute left-0 hidden h-[18px] w-px transition-[opacity,top] duration-300" style="top:33px;opacity:0"></div><div class="text-[14px] font-[600] leading-[28px]">本页目录</div><div><div><a href="#completeunitofwork" class="text-text-2 text-hover text-overflow block text-[13px] leading-[28px]" style="padding-left:0rem">completeUnitOfWork</a></div></div></div></aside></div></div></div>
  
    <script type="module" src="/client-entry.js"></script>
    </body>
    
</html>
